<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Orçamento - Oficina Mecânica</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --accent:#0f62fe; /* Azul forte para destacar os valores */
    --muted:#6b7280;
    --success:#10b981;
    --danger:#ef4444;
    --border: #e6e9ef;
    --radius:10px;
    font-family: 'Poppins', sans-serif;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    color:#111827;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:24px;
    padding-top: 70px; 
  }

  .container{
    max-width:1100px;
    margin:0 auto;
  }

  header.top{
    display:flex;
    gap:16px;
    align-items:center;
    margin-bottom:18px;
  }
  .brand{
    background:linear-gradient(135deg,#ffffff,#f1f6ff);
    padding:12px 16px;
    border-radius:12px;
    border:1px solid var(--border);
    display:flex;
    flex-direction:column;
    gap:6px;
    position:relative;
    flex-grow: 1; 
  }
  .brand h1{ margin:0; font-size:18px; font-weight:700; color:var(--accent) }
  .brand small{ color:var(--muted); font-size:12px }

  /* Logo Styling */
  .logo-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
  }
  #logo-img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: none;
  }
  .brand.has-logo {
      padding: 12px 16px 12px 80px; 
      min-height: 60px;
      display: flex;
      justify-content: center;
      flex-direction: column;
  }
  .brand.has-logo .logo-container {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 50px; 
      height: 50px; 
      background: #f0f4ff;
      border-radius: 6px;
      border: 1px solid var(--border);
  }
  .brand.has-logo #logo-img {
      display: block;
      width: 100%;
      height: 100%;
      object-fit: scale-down;
  }

  .meta{
    margin-left:auto;
    text-align:right;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    min-width: 150px;
  }
  .meta .number{ font-weight:700; font-size:16px }
  .meta small{ display:block; color:var(--muted); font-size:12px }

  /* BOTÕES DE AÇÃO FIXOS NO TOPO */
  .fixed-actions {
      position: fixed;
      top: 15px;
      right: 24px;
      z-index: 1010; 
      display: flex;
      gap: 10px;
  }
  .fixed-actions button, .fixed-actions label {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      padding: 0;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 10px rgba(12,20,50,0.15); 
  }

  /* Estilos específicos dos novos botões */
  #btn-select-logo {
      background: var(--accent);
      color: #fff;
      font-size: 20px;
  }
  #btn-config-oficina {
      background: var(--muted);
      color: #fff;
  }
  
  .fixed-actions button:hover, .fixed-actions label:hover {
      box-shadow: 0 6px 12px rgba(12,20,50,0.25);
      transform: scale(1.05); 
  }

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:16px;
    margin-bottom:16px;
    box-shadow: 0 1px 4px rgba(12,20,50,0.04);
  }

  .row{ display:flex; gap:12px; flex-wrap:wrap; }
  .col{ flex:1; min-width:220px; } /* Padrão, será sobrescrito abaixo */

  /* OTIMIZAÇÃO DE LARGURA PARA OS INPUTS DE CLIENTE/VEÍCULO */
  .info-group .row .col {
      /* Padrões mais compactos para telas grandes */
      flex: 1; /* Permite crescimento, mas tenta manter a linha */
      min-width: 150px; 
  }
  /* Ajustes específicos para campos muito pequenos */
  .info-group .row .col.col-placa, 
  .info-group .row .col.col-ano, 
  .info-group .row .col.col-cor, 
  .info-group .row .col.col-km {
      min-width: 90px; /* Campos bem compactos */
      flex: 0.3; /* Menor flex para preferir o tamanho mínimo */
  }
  .info-group .row .col.col-marca {
      min-width: 110px; 
      flex: 0.5; 
  }
  .info-group .row .col.col-modelo {
      min-width: 130px; 
      flex: 0.7; 
  }
  .info-group .row .col.col-tel, 
  .info-group .row .col.col-doc {
      min-width: 130px;
      flex: 0.7;
  }
  /* Fim OTIMIZAÇÃO DE LARGURA */

  /* Estilo para o botão de consulta de placa */
  .placa-consulta-container {
    display: flex;
    gap: 8px;
    align-items: flex-end;
  }
  .placa-consulta-container .col {
    flex: 1;
  }
  .placa-consulta-container button {
    height: 42px;
    margin-bottom: 6px;
    padding: 10px 16px;
    white-space: nowrap;
    font-size: 14px;
    font-weight: 600;
  }

  /* Destaque vermelho para placa */
  .placa-destaque {
    border: 2px solid #dc2626 !important;
    background-color: #fef2f2 !important;
    color: #dc2626 !important;
    font-weight: 700 !important;
  }
  .placa-destaque::placeholder {
    color: #fca5a5 !important;
  }
  .btn-placa-destaque {
    background: #dc2626 !important;
    color: white !important;
    border: 2px solid #dc2626 !important;
    font-weight: 700 !important;
  }
  .btn-placa-destaque:hover {
    background: #b91c1c !important;
    border-color: #b91c1c !important;
  }

  label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
  input[type="text"], input[type="number"], input[type="date"], textarea, select{
    width:100%;
    padding:10px 12px;
    border-radius:8px;
    border:1px solid var(--border);
    font-size:14px;
    background:#fff;
  }
  textarea{ min-height:64px; resize:vertical; }

  .small{ font-size:12px; color:var(--muted) }

  /* items table */
  table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:14px;}
  table thead th{
    text-align:left;
    font-weight:600;
    padding:10px;
    border-bottom:1px solid var(--border);
  }
  table tbody td{
    padding:10px;
    border-bottom:1px dashed #eee;
    vertical-align:middle;
  }
  .text-right{ text-align:right }
  .muted{ color:var(--muted); font-size:13px }
  
  /* DESTAQUE AZUL PARA VALORES NA TABELA */
  .valor-destaque {
      font-weight: 600;
      color: var(--accent); /* Destaque azul */
  }

  .actions{ display:flex; gap:8px; align-items:center; }

  button{
    padding:8px 12px;
    border-radius:8px;
    border:0;
    cursor:pointer;
    font-weight:600;
    transition: all 0.2s ease;
  }
  .btn-primary{ background:var(--accent); color:#fff; }
  .btn-primary:hover { opacity: 0.9; }
  .btn-ghost{ background:transparent; border:1px solid var(--border); color:#111827; }
  .btn-ghost:hover { background: #f0f4ff; }
  .btn-danger{ background:var(--danger); color:#fff; }
  .btn-danger:hover { opacity: 0.9; }
  .btn-success{ background:var(--success); color:#fff; }

  /* ----------------- AJUSTE DOS TOTAIS (HORIZONTAL E ALINHAMENTO) ----------------- */
  .totals-wrapper {
    display: flex;
    justify-content: flex-end; 
    margin-top: 12px;
  }
  .totals{
    display: flex; 
    gap: 12px; 
    align-items: center;
    flex-wrap: wrap; 
  }
  .totals .box{
    background:#f8fafc;
    border:1px solid var(--border);
    padding:10px 14px;
    border-radius:8px;
    min-width: 150px; 
    flex: 1; 
    text-align:right; /* Alinha o conteúdo à direita */
    margin-bottom: 0; 
  }
  .totals .box .label{ color:var(--muted); font-size:13px }
  /* DESTAQUE AZUL PARA VALORES TOTAIS */
  .totals .box .value{ font-weight:700; font-size:18px; color:var(--accent); }
  /* ----------------- FIM AJUSTE DOS TOTAIS ----------------- */

  /* ----------------- ASSINATURAS DIGITAIS ----------------- */
  .signature-section {
    margin-top: 16px;
    border-top: 1px solid var(--border);
    padding-top: 16px;
  }
  .signature-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-top: 12px;
  }
  .signature-box {
    flex: 1;
    min-width: 280px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    background: #fafbfc;
  }
  .signature-box h4 {
    margin: 0 0 12px 0;
    font-size: 14px;
    color: var(--muted);
    text-align: center;
  }
  .signature-canvas {
    width: 100%;
    height: 120px;
    border: 1px dashed var(--border);
    border-radius: 6px;
    background: white;
    cursor: crosshair;
    display: block;
  }
  .signature-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
    justify-content: center;
  }
  .signature-actions button {
    font-size: 12px;
    padding: 6px 10px;
  }
  /* ----------------- FIM ASSINATURAS DIGITAIS ----------------- */

  /* ----------------- CORREÇÃO DOS MODAIS ----------------- */
  .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 1000;
      overflow-y: auto; 
  }
  .modal-content {
      background: var(--card);
      padding: 24px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      animation: fadeIn 0.3s ease-out;
      margin: 20px 0; 
  }
  /* ----------------- FIM CORREÇÃO DOS MODAIS ----------------- */
  
  .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
  }
  .modal-header h3 { margin: 0; }
  .modal-close {
      background: transparent;
      font-size: 24px;
      line-height: 1;
      padding: 0;
      width: 24px;
      height: 24px;
      color: var(--muted);
  }
  .modal-close:hover {
      color: var(--danger);
  }

  /* Estilos para o Modal de Cópia */
  #copy-modal .modal-content {
    max-width: 450px;
  }
  #suggested-title {
    background: var(--bg);
    border: 1px dashed var(--accent);
    padding: 12px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    word-break: break-all;
    margin-bottom: 16px;
    color: var(--accent);
  }
  #copy-modal .modal-footer {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
  }
  #copy-btn {
    font-weight: 700;
    padding-left: 16px;
    padding-right: 16px;
  }
  #copy-btn.copy-success {
      background: var(--success);
      color: #fff;
  }

  @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
  }

  /* Footer para o botão de zerar OS */
  footer { 
      margin-top:18px; 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      gap:12px; 
      flex-wrap:wrap; 
  }
  #btn-reset-os {
      color: var(--danger);
      background: #fef2f2;
      border: 1px solid var(--danger);
  }
  #btn-reset-os:hover {
      background: var(--danger);
      color: #fff;
  }

  /* ---------------------- INÍCIO OTIMIZAÇÃO DE IMPRESSÃO ---------------------- */
  @media print{
    html, body {
        height: auto;
        max-height: none;
        overflow: visible;
        padding-top: 0 !important;
        font-size: 12px; 
    }
    body{
        padding:0;
        background:#fff;
        margin: 0;
        width: 100%;
    }
    .container {
        max-width: 100%;
        padding: 0 15px; 
        margin: 0;
    }

    .card{
        box-shadow:none;
        border:1px solid #ddd;
        margin:10px 0;
        border-radius:0;
        padding: 12px; 
        page-break-inside: avoid;
    }

    .row { 
        gap: 8px; 
        align-items: flex-start;
        justify-content: flex-start;
    }
    /* Regra de compactação específica para a impressão */
    .info-group .row .col {
        min-width: 100px !important; 
        flex: 1 1 100px !important; 
    }
    /* Campos que precisam de mais espaço no print */
    .info-group .row .col.col-nome { min-width: 200px !important; flex: 2 !important; }
    .info-group .row .col.col-doc,
    .info-group .row .col.col-tel { min-width: 140px !important; flex: 1.5 !important; }
    .info-group .row .col.col-marca { min-width: 120px !important; flex: 1.2 !important; }
    .info-group .row .col.col-modelo { min-width: 150px !important; flex: 1.5 !important; }
    .info-group .row .col.col-placa,
    .info-group .row .col.col-ano,
    .info-group .row .col.col-cor,
    .info-group .row .col.col-km { min-width: 90px !important; flex: 1 !important; }
    
    label, .small, .muted { 
        font-size: 10px !important; 
        margin-bottom: 3px; 
    }
    input[type="text"], input[type="number"], input[type="date"], textarea, select{
        padding: 4px 6px; 
        font-size: 11px;
        border: 1px solid #ccc;
    }
    textarea { min-height: 40px; } 
    
    table thead th, table tbody td { padding: 4px 8px; } 
    h3 { font-size: 14px; margin: 0 0 5px 0 !important; } 

    .no-print, .modal-overlay, .fixed-actions, .signature-actions { display:none !important }
    header.top{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }

    .brand.has-logo {
      padding: 8px 16px 8px 70px; 
      min-height: 50px;
    }
    .brand.has-logo .logo-container {
        width: 40px; 
        height: 40px; 
    }
    .brand h1{ font-size:16px; }
    .brand small{ font-size:10px }

    /* Ajustes dos totais no print */
    .totals-wrapper {
        justify-content: flex-end; 
        margin-top: 8px;
    }
    .totals{
        display: flex;
        gap: 10px; 
    }
    .totals .box {
        min-width: 130px; 
        flex: 1; 
        padding: 6px 10px;
        background: #fff; 
        border: 1px solid #ddd;
        margin-bottom: 0; 
        text-align: right; 
    }
    .totals .box .label { font-size: 11px; }
    .totals .box .value { 
        font-size: 14px; 
    }
    
    footer { margin-top: 10px; }
    
    /* Assinaturas no print */
    .signature-canvas {
        border: 1px solid #ccc;
        height: 80px;
    }
    
    /* Estilo para página de informações do veículo */
    .vehicle-info-page {
        page-break-before: always;
        border: 2px solid #dc2626;
        padding: 15px;
        margin: 10px 0;
        background: #fef2f2;
    }
    /* Oculta o conteúdo normal da div #vehicle-info-content no print */
    #vehicle-info-container #vehicle-info-content {
        display: none; 
    }
    /* Oculta a estrutura de impressão na tela */
    #vehicle-info-container .vehicle-info-page {
        display: none; 
    }
    /* Mostra a estrutura de impressão no print */
    @media print {
        #vehicle-info-container .vehicle-info-page {
            display: block !important; 
        }
    }
    
    .vehicle-info-page h2 {
        color: #dc2626;
        text-align: center;
        border-bottom: 2px solid #dc2626;
        padding-bottom: 8px;
        margin-bottom: 15px;
        font-size: 18px;
    }
    .vehicle-detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-bottom: 15px;
    }
    .vehicle-detail-item {
        border-bottom: 1px dashed #ddd;
        padding: 5px 0;
        display: flex;
        justify-content: space-between;
    }
    .vehicle-detail-label {
        font-weight: bold;
        color: #333;
        flex: 1;
    }
    .vehicle-detail-value {
        color: #666;
        flex: 1;
        text-align: right;
    }
    .vehicle-section {
        margin-bottom: 20px;
    }
    .vehicle-section h3 {
        background: #dc2626;
        color: white;
        padding: 8px 12px;
        margin: 0 0 10px 0;
        font-size: 14px;
        border-radius: 4px;
    }
    
    /* Ocultar campos vazios no print */
    .empty-field {
        display: none !important;
    }
    
    /* Estilo para a logo da marca no print */
    .vehicle-logo {
        text-align: center;
        margin-bottom: 15px;
    }
    .vehicle-logo img {
        max-height: 60px;
        max-width: 120px;
    }
    
    /* Destaque para placa no print */
    .placa-destaque-print {
        border: 2px solid #dc2626 !important;
        background-color: #fef2f2 !important;
        font-weight: bold !important;
        color: #dc2626 !important;
    }
  }
  /* ---------------------- FIM OTIMIZAÇÃO DE IMPRESSÃO ---------------------- */

  /* responsive */
  @media (max-width:760px){
    .meta{text-align:left; margin-left:0; align-items: flex-start; }
    .fixed-actions {
        top: 15px;
        right: 15px; 
    }
    footer {
        flex-direction: column;
        align-items: stretch;
    }
    footer > div {
        width: 100%;
        text-align: center;
    }
    /* Em telas pequenas, permite quebrar o row para melhor usabilidade */
    .info-group .row .col {
        min-width: 48% !important; 
        flex: 1 1 48% !important; 
    }
    
    .signature-container {
        flex-direction: column;
    }
    .signature-box {
        min-width: 100%;
    }
    
    .vehicle-detail-grid {
        grid-template-columns: 1fr;
    }
    
    .placa-consulta-container {
        flex-direction: column;
    }
    .placa-consulta-container button {
        width: 100%;
        margin-top: 5px;
    }
  }
</style>
</head>
<body>
  
  <div class="fixed-actions no-print">
      <button id="btn-config-oficina" title="Configurações da Oficina">⚙️</button>
      
      <label for="logo-upload" id="btn-select-logo" title="Adicionar / Alterar Logo">🖼️</label>
      <input type="file" id="logo-upload" accept="image/*" style="display:none;">
  </div>

  <div class="container">
    <header class="top">
      <div class="brand" id="brand-container">
        
        <div class="logo-container">
            <img id="logo-img" src="" alt="Logo da Oficina">
        </div>
        <h1 id="oficina-nome-display">Oficina Mecânica</h1>
        <small id="oficina-info">Nome da Oficina • Telefone • Endereço</small>
      </div>

      <div class="meta">
        <div class="number">ORÇAMENTO Nº <span id="orc-num">0001</span></div>
        <small>Data emissão: <span id="data-emissao"></span></small>
        <small class="muted" id="validade-badge">Validade: 7 dias</small>
      </div>
    </header>

    <div class="card info-group">
      <h3 style="margin:0 0 8px 0">Dados do Cliente e do Veículo</h3>
      
      <div class="row">
        <div class="col col-nome">
          <label>Nome</label>
          <input id="cliente-nome" type="text" placeholder="Nome completo">
        </div>
        <div class="col col-doc">
          <label>CPF / CNPJ</label>
          <input id="cliente-doc" type="text" placeholder="000.000.000-00">
        </div>
        <div class="col col-tel">
          <label>Telefone / WhatsApp</label>
          <input id="cliente-tel" type="text" placeholder="(00) 9 0000-0000">
        </div>
        
        <div class="placa-consulta-container">
          <div class="col col-placa">
            <label>Placa</label>
            <input id="veic-placa" type="text" placeholder="ABC1A23" maxlength="8" inputmode="text" style="text-transform: uppercase;" class="placa-destaque">
          </div>
          <button class="btn-placa-destaque" id="btn-consultar-placa" title="Consultar dados da placa">🔍 Buscar Placa</button>
        </div>
      </div>

      <h3 style="margin:12px 0 8px 0">Informações Básicas do Veículo</h3>
      <div class="row">
        <div class="col col-marca">
          <label>Marca</label>
          <input id="veic-marca" type="text" placeholder="Ex: VW">
        </div>
        <div class="col col-modelo">
          <label>Modelo</label>
          <input id="veic-modelo" type="text" placeholder="Ex: CROSSFOX">
        </div>
        <div class="col">
          <label>Submodelo</label>
          <input id="veic-submodelo" type="text" placeholder="Ex: CROSSFOX">
        </div>
        <div class="col">
          <label>Versão</label>
          <input id="veic-versao" type="text" placeholder="Ex: CROSSFOX">
        </div>
      </div>
      
      <div class="row" style="margin-top: 12px;">
        <div class="col col-ano">
          <label>Ano Fabricação</label>
          <input id="veic-ano-fabricacao" type="text" placeholder="2007">
        </div>
        <div class="col">
          <label>Ano Modelo</label>
          <input id="veic-ano-modelo" type="text" placeholder="2007">
        </div>
        <div class="col col-cor">
          <label>Cor</label>
          <input id="veic-cor" type="text" placeholder="Ex: Prata">
        </div>
        <div class="col col-km">
          <label>Km</label>
          <input id="veic-km" type="text" placeholder="123456" maxlength="6" inputmode="numeric" pattern="[0-9]*">
        </div>
      </div>

      <h3 style="margin:12px 0 8px 0">Diagnóstico</h3>
      <div>
        <textarea id="diagnostico" placeholder="Descreva o problema relatado e observações do mecânico"></textarea>
      </div>
    </div>

    <div id="vehicle-info-container" class="card">
      <h3 style="margin:0 0 8px 0">Informações Completas do Veículo</h3>
      <div id="vehicle-info-content">
        <p class="muted">As informações completas do veículo aparecerão aqui após a consulta da placa.</p>
      </div>
      <div id="vehicle-info-page-print" class="vehicle-info-page">
          </div>
    </div>

    <div class="card">
        <h3 style="margin:0 0 8px 0">Responsáveis</h3>
        <div class="row">
            <div class="col">
                <label>Mecânico Responsável</label>
                <input id="mecanico-resp" type="text" placeholder="Nome do Mecânico">
            </div>
            <div class="col">
                <label>Consultor Responsável</label>
                <input id="consultor-resp" type="text" placeholder="Nome do Consultor / Vendedor">
            </div>
        </div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
        <h3 style="margin:0">Itens (Peças e Serviços)</h3>
        <div class="no-print">
          <button class="btn-primary" id="btn-add-item" title="Adicionar item">+ Adicionar item</button>
        </div>
      </div>

      <table id="tabela-itens" aria-label="Tabela de itens do orçamento">
        <thead>
          <tr>
            <th style="width:6%">#</th>
            <th style="width:36%">Descrição</th>
            <th style="width:12%">Qtd</th>
            <th style="width:14%">Valor Unit.</th>
            <th style="width:14%">Subtotal</th>
            <th style="width:18%" class="no-print">Ações</th>
          </tr>
        </thead>
        <tbody id="itens-body">
          </tbody>
      </table>

      <div class="totals-wrapper">
        <div class="totals">
            <div class="box">
            <div class="label">Total peças</div>
            <div class="value" id="total-pecas">R$ 0,00</div>
            </div>

            <div class="box">
            <div class="label">Total mão de obra</div>
            <div class="value" id="total-mdo">R$ 0,00</div>
            </div>

            <div class="box">
            <div class="label">TOTAL GERAL</div>
            <div class="value" id="total-geral">R$ 0,00</div>
            </div>
        </div>
      </div>
      <div style="display:flex; justify-content:space-between; gap:12px; margin-top:12px; align-items:center; flex-wrap:wrap;">
        <div class="muted">Observação: valores podem variar caso sejam identificados novos serviços após abertura.</div>

        <div class="no-print actions">
          <button class="btn-ghost" id="btn-salvar">Salvar (local)</button>
          <button class="btn-ghost" id="btn-limpar">Limpar</button>
          <button class="btn-primary" id="btn-imprimir">Gerar PDF / Imprimir</button>
          <button class="btn-success" id="btn-whatsapp">📱 Enviar WhatsApp</button>
          <button class="btn-success" id="btn-copy-all">📋 Copiar Tudo</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>Prazo estimado</label>
          <input type="text" id="prazo" placeholder="Ex: 2 dias úteis">
        </div>
        <div class="col">
          <label>Validade do orçamento</label>
          <input type="number" id="validade" min="1" value="7"> <span class="small">dias</span>
        </div>
        <div class="col">
          <label>Garantia serviço</label>
          <input type="text" id="garantia" placeholder="Ex: 90 dias - serviços">
        </div>
      </div>

      <div style="margin-top:12px;">
        <label>Condições de pagamento</label>
        <input type="text" id="condicoes" placeholder="Ex: À vista PIX / Cartão / Parcelado">
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">Aprovação do Cliente</h3>
      <div class="row">
        <div class="col">
          <label>Nome do aprovador</label>
          <input id="aprovador" type="text" placeholder="Nome completo">
        </div>
        <div class="col">
          <label>Data de aprovação</label>
          <input id="data-aprov" type="date">
        </div>
        <div class="col">
          <label>Assinatura responsável</label>
          <input id="assinatura" type="text" placeholder="Nome para registrar como assinatura">
        </div>
      </div>
      
      <div class="signature-section">
        <h4>Assinaturas</h4>
        <div class="signature-container">
          <div class="signature-box">
            <h4>Assinatura do Cliente</h4>
            <canvas id="signature-client" class="signature-canvas"></canvas>
            <div class="signature-actions no-print">
              <button class="btn-ghost" id="btn-clear-client">Limpar</button>
              <button class="btn-primary" id="btn-save-client">Salvar Assinatura</button>
            </div>
          </div>
          <div class="signature-box">
            <h4>Assinatura do Mecânico</h4>
            <canvas id="signature-mechanic" class="signature-canvas"></canvas>
            <div class="signature-actions no-print">
              <button class="btn-ghost" id="btn-clear-mechanic">Limpar</button>
              <button class="btn-primary" id="btn-save-mechanic">Salvar Assinatura</button>
            </div>
          </div>
        </div>
      </div>
      
      <div style="margin-top:10px;" class="muted">Ao assinar, o cliente concorda com os termos do orçamento e autoriza o início dos serviços mediante aprovação.</div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">Observações internas</h3>
      <textarea id="obs-interna" placeholder="Observações para uso interno (data início, notas)"></textarea>
    </div>

    <footer>
      <div class="small muted">Orçamento gerado pelo sistema • Recomenda-se revisar valores antes de aprovar.</div>
      <div class="actions no-print">
        <button class="btn-ghost" id="btn-export-json">Exportar JSON</button>
        <button class="btn-ghost" id="btn-reset-os">Zerar Contador de OS</button>
      </div>
    </footer>
  </div>

  <div class="modal-overlay" id="item-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Adicionar Novo Item</h3>
        <button class="modal-close" id="btn-close-modal-item">×</button>
      </div>
      <div class="modal-body" style="display:flex; flex-direction:column; gap:12px;">
        <div>
          <label>Descrição (Peça/Serviço)</label>
          <input id="item-descricao" type="text" placeholder="Ex: Óleo de motor 5w40 / Troca de Correia">
        </div>
        <div>
          <label>Tipo</label>
          <select id="item-tipo">
            <option value="PECA">Peça</option>
            <option value="MDO">Mão de Obra (Serviço)</option>
          </select>
        </div>
        <div class="row">
            <div class="col" style="min-width: 100px; flex: 1;">
                <label>Quantidade</label>
                <input id="item-qtd" type="text" inputmode="numeric" pattern="[0-9]*" value="1">
            </div>
            <div class="col" style="min-width: 150px; flex: 2;">
                <label>Valor Unitário (R$)</label>
                <input id="item-valor" type="text" inputmode="decimal" placeholder="R$ 0,00">
            </div>
        </div>
        <div>
          <label>Observações do Item (Opcional)</label>
          <textarea id="item-obs" placeholder="Detalhes técnicos, código da peça, etc."></textarea>
        </div>
      </div>
      <div style="margin-top:20px; text-align:right;">
        <button class="btn-ghost" id="btn-cancel-modal-item">Cancelar</button>
        <button class="btn-primary" id="btn-save-item">Salvar Item</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="config-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="config-modal-title">Configurações da Oficina</h3>
            <button class="modal-close" id="btn-close-modal-config">×</button>
        </div>
        <div class="modal-body" style="display:flex; flex-direction:column; gap:12px;">
            <div>
                <label>Nome da Oficina</label>
                <input id="config-nome" type="text" placeholder="Nome Fantasia">
            </div>
            <div>
                <label>Telefone / WhatsApp</label>
                <input id="config-telefone" type="text" placeholder="(00) 0 0000-0000">
            </div>
            <div>
                <label>Endereço Completo</label>
                <textarea id="config-endereco" placeholder="Rua, Número, Bairro, Cidade - Estado"></textarea>
            </div>
        </div>
        <div style="margin-top:20px; text-align:right;">
            <button class="btn-ghost" id="btn-cancel-modal-config">Cancelar</button>
            <button class="btn-primary" id="btn-save-config">Salvar Configurações</button>
        </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="copy-modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>Preparar Geração de PDF</h3>
              <button class="modal-close" id="btn-close-copy-modal">×</button>
          </div>
          <div class="modal-body">
              <p>O nome sugerido para o arquivo PDF é:</p>
              <div id="suggested-title" title="Clique no botão para copiar."></div>
              <p class="small muted">Atenção: Copie o título acima e cole-o na janela de salvamento do seu navegador para garantir o nome correto.</p>
          </div>
          <div class="modal-footer">
              <button class="btn-ghost" id="btn-cancel-pdf">Cancelar</button>
              <button class="btn-primary" id="copy-btn">Copiar Título</button>
              <button class="btn-primary" id="generate-pdf-btn">Gerar PDF</button>
          </div>
      </div>
  </div>

<script>
  // Utilitários
  const fmt = new Intl.NumberFormat('pt-BR',{ style:'currency', currency:'BRL' });

  // Elementos - Header
  const titleEl = document.querySelector('title');
  const originalTitle = titleEl.textContent; 
  const brandContainerEl = document.getElementById('brand-container');
  const logoImgEl = document.getElementById('logo-img');
  const logoUploadInput = document.getElementById('logo-upload');
  const btnConfigOficina = document.getElementById('btn-config-oficina');
  const oficinaNomeDisplay = document.getElementById('oficina-nome-display');
  const oficinaInfoEl = document.getElementById('oficina-info');
  const dataEmissaoEl = document.getElementById('data-emissao');
  const orcNumEl = document.getElementById('orc-num');
  const validadeInput = document.getElementById('validade');
  const validadeBadge = document.getElementById('validade-badge');

  // Elementos - Inputs Principais
  const clienteNome = document.getElementById('cliente-nome');
  const clienteDoc = document.getElementById('cliente-doc');
  const clienteTel = document.getElementById('cliente-tel');
  const veicPlaca = document.getElementById('veic-placa');
  const veicMarca = document.getElementById('veic-marca'); 
  const veicModelo = document.getElementById('veic-modelo');
  const veicSubmodelo = document.getElementById('veic-submodelo');
  const veicVersao = document.getElementById('veic-versao');
  const veicAnoFabricacao = document.getElementById('veic-ano-fabricacao');
  const veicAnoModelo = document.getElementById('veic-ano-modelo');
  const veicCor = document.getElementById('veic-cor'); 
  const veicKm = document.getElementById('veic-km');
  const diagnostico = document.getElementById('diagnostico');
  const prazo = document.getElementById('prazo');
  const garantia = document.getElementById('garantia');
  const condicoes = document.getElementById('condicoes');
  const aprovador = document.getElementById('aprovador');
  const dataAprov = document.getElementById('data-aprov');
  const assinatura = document.getElementById('assinatura');
  const obsInterna = document.getElementById('obs-interna');
  
  // Responsáveis
  const mecanicoResp = document.getElementById('mecanico-resp');
  const consultorResp = document.getElementById('consultor-resp');

  // Elementos - Itens e Totais
  const itensBody = document.getElementById('itens-body');
  const totalPecasEl = document.getElementById('total-pecas');
  const totalMdoEl = document.getElementById('total-mdo');
  const totalGeralEl = document.getElementById('total-geral');

  // Elementos - Ações
  const btnAddItem = document.getElementById('btn-add-item');
  const btnImprimir = document.getElementById('btn-imprimir');
  const btnSalvar = document.getElementById('btn-salvar');
  const btnLimpar = document.getElementById('btn-limpar');
  const btnExportJson = document.getElementById('btn-export-json');
  const btnResetOs = document.getElementById('btn-reset-os'); 
  const btnConsultarPlaca = document.getElementById('btn-consultar-placa');
  const btnWhatsapp = document.getElementById('btn-whatsapp');
  const btnCopyAll = document.getElementById('btn-copy-all');

  // Elementos - Modal Item
  const itemModal = document.getElementById('item-modal');
  const modalTitle = document.getElementById('modal-title');
  const btnCloseModalItem = document.getElementById('btn-close-modal-item');
  const btnCancelModalItem = document.getElementById('btn-cancel-modal-item');
  const btnSaveItem = document.getElementById('btn-save-item');
  const itemDescricaoInput = document.getElementById('item-descricao');
  const itemTipoSelect = document.getElementById('item-tipo');
  const itemQtdInput = document.getElementById('item-qtd');
  const itemValorInput = document.getElementById('item-valor');
  const itemObsTextarea = document.getElementById('item-obs');

  // Elementos - Modal Configuração
  const configModal = document.getElementById('config-modal');
  const btnCloseModalConfig = document.getElementById('btn-close-modal-config');
  const btnCancelModalConfig = document.getElementById('btn-cancel-modal-config');
  const btnSaveConfig = document.getElementById('btn-save-config');
  const configNomeInput = document.getElementById('config-nome');
  const configTelefoneInput = document.getElementById('config-telefone');
  const configEnderecoTextarea = document.getElementById('config-endereco');
  
  // Elementos do Modal de Cópia
  const copyModal = document.getElementById('copy-modal');
  const suggestedTitleEl = document.getElementById('suggested-title');
  const btnCloseCopyModal = document.getElementById('btn-close-copy-modal');
  const btnCancelPdf = document.getElementById('btn-cancel-pdf');
  const copyBtn = document.getElementById('copy-btn');
  const generatePdfBtn = document.getElementById('generate-pdf-btn');

  // Elementos de Assinatura
  const signatureClient = document.getElementById('signature-client');
  const signatureMechanic = document.getElementById('signature-mechanic');
  const btnClearClient = document.getElementById('btn-clear-client');
  const btnSaveClient = document.getElementById('btn-save-client');
  const btnClearMechanic = document.getElementById('btn-clear-mechanic');
  const btnSaveMechanic = document.getElementById('btn-save-mechanic');

  // Container para informações do veículo
  const vehicleInfoContainer = document.getElementById('vehicle-info-container');
  const vehicleInfoContent = document.getElementById('vehicle-info-content');
  const vehicleInfoPagePrint = document.getElementById('vehicle-info-page-print'); // NOVO ELEMENTO

  let editingItemIndex = -1;
  let isDrawing = false;
  let lastX = 0;
  let lastY = 0;
  let currentCanvas = null;

  // Dados (Estado Inicial/Padrão)
  let orcamento = {
    numero: 1,
    dataEmissao: new Date().toISOString().slice(0,10),
    validadeDias: 7,
    oficina: { nome:'Auto Box Mecânica', telefone:'(99) 9 9999-9999', endereco:'Rua Exemplo, 123', logoUrl: '' },
    cliente: {},
    veiculo: {},
    responsaveis: { mecanico: '', consultor: '' }, 
    diagnostico: '',
    itens: [],
    prazo: '',
    garantia: '',
    condicoes: '',
    aprovacao: {},
    obsInterna: '',
    assinaturas: {
      cliente: '',
      mecanico: ''
    },
    // Novos campos para armazenar todas as informações da API
    veiculoCompleto: {
      informacoesBasicas: {},
      informacoesExtra: {},
      informacoesFipe: {},
      situacao: {}
    }
  };
  
  // --- FUNÇÕES DE MÁSCARA E FORMATAÇÃO ---

  const cleanNumber = (value) => value ? value.toString().replace(/\D/g, '') : '';
  const cleanAlphaNumeric = (value) => value ? value.toString().replace(/[^a-zA-Z0-9]/g, '') : '';

  function maskCpfCnpj(value) {
      const v = cleanNumber(value);
      if (v.length <= 11) { 
          return v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4').slice(0, 14);
      } else { 
          return v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5').slice(0, 18);
      }
  }

  function maskPhone(value) {
      const v = cleanNumber(value).slice(0, 11);
      if (v.length <= 10) { 
          return v.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
      } else { 
          return v.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
      }
  }
  
  function maskPlaca(value) {
      const v = cleanAlphaNumeric(value).toUpperCase().slice(0, 7);
      if (v.length > 3) {
          return v.replace(/^(.{3})(.{1})(.{3})$/, '$1-$2$3');
      }
      return v;
  }
  
  function formatKmForDisplay(value) {
      const v = cleanNumber(value).slice(0, 6);
      if (v) return `${v.replace(/\B(?=(\d{3})+(?!\d))/g, '.')} km`;
      return '';
  }

  function maskMoney(value) {
      let v = cleanNumber(value);
      if (!v) return '';

      const decimalPart = v.slice(-2).padStart(2, '0');
      let integerPart = v.slice(0, -2);
      
      if (integerPart.length > 1 && integerPart[0] === '0') {
          integerPart = integerPart.replace(/^0+/, '');
          if (integerPart === '') integerPart = '0';
      } else if (integerPart === '') {
          integerPart = '0';
      }

      let masked = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      
      masked = `R$ ${masked},${decimalPart}`;
      return masked;
  }

  function unmaskMoney(value) {
    if (!value) return 0;
    const clean = value.toString().replace(/[^0-9,]/g, '').replace(',', '.');
    return parseFloat(clean) || 0;
  }

  function formatDateBr(iso){
    if(!iso) return '';
    const d = new Date(iso + 'T00:00:00'); 
    if(isNaN(d)) return iso;
    const day = String(d.getDate()).padStart(2,'0');
    const month = String(d.getMonth()+1).padStart(2,'0');
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
  }

  // --- LÓGICA DE NEGÓCIO ---

  function calcularTotais() {
    let totalPecas = 0;
    let totalMDO = 0;

    orcamento.itens.forEach(item => {
      const subtotal = item.qtd * item.valor;
      if (item.tipo === 'PECA') {
        totalPecas += subtotal;
      } else if (item.tipo === 'MDO') {
        totalMDO += subtotal;
      }
    });

    const totalGeral = totalPecas + totalMDO;

    totalPecasEl.textContent = fmt.format(totalPecas);
    totalMdoEl.textContent = fmt.format(totalMDO);
    totalGeralEl.textContent = fmt.format(totalGeral);
  }

  function renderItens(){
    itensBody.innerHTML = '';
    orcamento.itens.forEach((item, index) => {
      const subtotal = item.qtd * item.valor;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${index + 1}</td>
        <td>
            ${item.descricao} 
            ${item.obs ? `<div class="muted small">${item.obs}</div>` : ''}
            <div class="muted small">(${item.tipo === 'PECA' ? 'Peça' : 'Mão de Obra'})</div>
        </td>
        <td class="text-right">${item.qtd}</td>
        <td class="text-right valor-destaque">${fmt.format(item.valor)}</td>
        <td class="text-right valor-destaque">${fmt.format(subtotal)}</td>
        <td class="no-print actions">
            <button class="btn-ghost small" data-action="edit" data-index="${index}">✏️</button>
            <button class="btn-danger small" data-action="delete" data-index="${index}">🗑️</button>
        </td>
      `;
      itensBody.appendChild(row);
    });
    calcularTotais();
  }

  function openItemModal(index = -1) {
    editingItemIndex = index;
    
    if (index > -1) {
      modalTitle.textContent = 'Editar Item';
      const item = orcamento.itens[index];
      itemDescricaoInput.value = item.descricao;
      itemTipoSelect.value = item.tipo;
      itemQtdInput.value = item.qtd;
      itemValorInput.value = maskMoney(item.valor.toFixed(2));
      itemObsTextarea.value = item.obs;
    } else {
      modalTitle.textContent = 'Adicionar Novo Item';
      itemDescricaoInput.value = '';
      itemTipoSelect.value = 'PECA';
      itemQtdInput.value = '1';
      itemValorInput.value = '';
      itemObsTextarea.value = '';
    }

    itemModal.style.display = 'flex';
  }

  function closeItemModal() {
    itemModal.style.display = 'none';
    editingItemIndex = -1;
  }
  
  function openConfigModal() {
      configModal.style.display = 'flex';
      configNomeInput.value = orcamento.oficina.nome || '';
      configTelefoneInput.value = orcamento.oficina.telefone || '';
      configEnderecoTextarea.value = orcamento.oficina.endereco || '';
  }

  function closeConfigModal() {
      configModal.style.display = 'none';
      renderAll();
  }

  // Lógica de Salvamento e Configuração
  btnSaveItem.addEventListener('click', () => {
    const descricao = itemDescricaoInput.value.trim();
    const tipo = itemTipoSelect.value;
    const qtd = parseFloat(itemQtdInput.value.replace(',', '.')) || 0;
    const valor = unmaskMoney(itemValorInput.value);
    const obs = itemObsTextarea.value.trim();

    if (!descricao || qtd <= 0 || valor < 0) {
      alert('Preencha a descrição, quantidade e valor unitário corretamente.');
      return;
    }
    
    const newItem = {
      descricao,
      tipo,
      qtd,
      valor,
      obs
    };

    if (editingItemIndex > -1) {
      orcamento.itens[editingItemIndex] = newItem;
    } else {
      orcamento.itens.push(newItem);
    }

    closeItemModal();
    persist();
    renderAll();
  });

  btnSaveConfig.addEventListener('click', () => {
    orcamento.oficina.nome = configNomeInput.value.trim();
    orcamento.oficina.telefone = configTelefoneInput.value.trim();
    orcamento.oficina.endereco = configEnderecoTextarea.value.trim();

    persist();
    closeConfigModal();
  });

  // --- FUNÇÕES DE CONSULTA DE PLACA ---
  
  // 🚨 ATENÇÃO: EM PRODUÇÃO, NUNCA EXPOR O TOKEN NO FRONTEND COMO AQUI!
  const TOKEN = "41345b4cfc0993884e04cbcd0de66fa1";
  const API_BASE_URL = "https://wdapi2.com.br/consulta/";

  async function consultarPlaca() {
    const placa = cleanAlphaNumeric(veicPlaca.value).toUpperCase();
    
    if (!placa) {
      alert("Por favor, digite a placa do veículo.");
      return;
    }

    // Mostrar indicador de carregamento
    btnConsultarPlaca.textContent = "⏳ Buscando...";
    btnConsultarPlaca.disabled = true;

    const url = `${API_BASE_URL}${placa}/${TOKEN}`;

    try {
      const response = await fetch(url);
      const data = await response.json();
      
      if (response.ok) {
        // Processar e armazenar todos os dados da API
        processarDadosAPI(data);
        alert('Dados do veículo preenchidos automaticamente!');
        persist();
      } else if (data.message) {
        alert(`Erro na consulta: ${data.message}`);
      } else {
        alert('Erro desconhecido na consulta da placa.');
      }

    } catch (error) {
      console.error('Erro na requisição:', error);
      alert("Não foi possível conectar à API. Verifique sua conexão.");
    } finally {
      // Restaurar botão
      btnConsultarPlaca.textContent = "🔍 Buscar Placa";
      btnConsultarPlaca.disabled = false;
    }
  }

  function processarDadosAPI(data) {
    // Limpar dados anteriores
    orcamento.veiculoCompleto = {
      informacoesBasicas: {},
      informacoesExtra: {},
      informacoesFipe: {},
      situacao: {}
    };

    // Informações básicas
    if (data.marca) {
      veicMarca.value = data.marca;
      orcamento.veiculoCompleto.informacoesBasicas.marca = data.marca;
    }
    if (data.modelo) {
      veicModelo.value = data.modelo;
      orcamento.veiculoCompleto.informacoesBasicas.modelo = data.modelo;
    }
    if (data.submodelo) {
      veicSubmodelo.value = data.submodelo;
      orcamento.veiculoCompleto.informacoesBasicas.submodelo = data.submodelo;
    }
    if (data.versao) {
      veicVersao.value = data.versao;
      orcamento.veiculoCompleto.informacoesBasicas.versao = data.versao;
    }
    if (data.ano) {
      veicAnoFabricacao.value = data.ano;
      orcamento.veiculoCompleto.informacoesBasicas.anoFabricacao = data.ano;
    }
    if (data.anoModelo) {
      veicAnoModelo.value = data.anoModelo;
      orcamento.veiculoCompleto.informacoesBasicas.anoModelo = data.anoModelo;
    }
    if (data.cor) {
      veicCor.value = data.cor;
      orcamento.veiculoCompleto.informacoesBasicas.cor = data.cor;
    }
    if (data.chassi) {
      orcamento.veiculoCompleto.informacoesBasicas.chassi = data.chassi;
    }
    if (data.placa) {
      orcamento.veiculoCompleto.informacoesBasicas.placa = data.placa;
    }
    if (data.placa_alternativa) {
      orcamento.veiculoCompleto.informacoesBasicas.placaAlternativa = data.placa_alternativa;
    }
    if (data.marcaModelo) {
      orcamento.veiculoCompleto.informacoesBasicas.marcaModelo = data.marcaModelo;
    }
    if (data.origem) {
      orcamento.veiculoCompleto.informacoesBasicas.origem = data.origem;
    }
    if (data.municipio) {
      orcamento.veiculoCompleto.informacoesBasicas.municipio = data.municipio;
    }
    if (data.uf) {
      orcamento.veiculoCompleto.informacoesBasicas.uf = data.uf;
    }
    if (data.logo) {
      orcamento.veiculoCompleto.informacoesBasicas.logo = data.logo;
    }

    // Informações extra
    if (data.extra) {
      orcamento.veiculoCompleto.informacoesExtra = { ...data.extra };
    }

    // Informações FIPE
    if (data.fipe && data.fipe.dados && data.fipe.dados.length > 0) {
      // Pegar o item com maior score
      const melhorFipe = data.fipe.dados.reduce((prev, current) => 
        (prev.score > current.score) ? prev : current
      );
      orcamento.veiculoCompleto.informacoesFipe = { ...melhorFipe };
    }

    // Situação do veículo
    if (data.situacao) {
      orcamento.veiculoCompleto.situacao.situacao = data.situacao;
    }
    if (data.codigoSituacao) {
      orcamento.veiculoCompleto.situacao.codigoSituacao = data.codigoSituacao;
    }
    if (data.data) {
      orcamento.veiculoCompleto.situacao.dataConsulta = data.data;
    }

    // Atualizar interface
    renderAll();
    renderVehicleInfo();
  }

  // --- FUNÇÕES DE ASSINATURA DIGITAL ---
  
  function initSignatureCanvas() {
    // Configurar ambos os canvas
    const canvases = [signatureClient, signatureMechanic];
    
    canvases.forEach(canvas => {
      const ctx = canvas.getContext('2d');
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      // Limpar canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Adicionar eventos
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      
      // Para dispositivos touch
      canvas.addEventListener('touchstart', startDrawingTouch);
      canvas.addEventListener('touchmove', drawTouch);
      canvas.addEventListener('touchend', stopDrawing);
    });
  }
  
  function startDrawing(e) {
    isDrawing = true;
    currentCanvas = e.target;
    const rect = currentCanvas.getBoundingClientRect();
    lastX = e.clientX - rect.left;
    lastY = e.clientY - rect.top;
  }
  
  function startDrawingTouch(e) {
    e.preventDefault();
    isDrawing = true;
    currentCanvas = e.target;
    const rect = currentCanvas.getBoundingClientRect();
    const touch = e.touches[0];
    lastX = touch.clientX - rect.left;
    lastY = touch.clientY - rect.top;
  }
  
  function draw(e) {
    if (!isDrawing || currentCanvas !== e.target) return;
    
    const rect = currentCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    const ctx = currentCanvas.getContext('2d');
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
    
    lastX = x;
    lastY = y;
  }
  
  function drawTouch(e) {
    e.preventDefault();
    if (!isDrawing || currentCanvas !== e.target) return;
    
    const rect = currentCanvas.getBoundingClientRect();
    const touch = e.touches[0];
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    
    const ctx = currentCanvas.getContext('2d');
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
    
    lastX = x;
    lastY = y;
  }
  
  function stopDrawing() {
    isDrawing = false;
  }
  
  function clearSignature(canvasId) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Remover do orçamento
    if (canvasId === 'signature-client') {
      orcamento.assinaturas.cliente = '';
    } else if (canvasId === 'signature-mechanic') {
      orcamento.assinaturas.mecanico = '';
    }
    
    persist();
  }
  
  function saveSignature(canvasId) {
    const canvas = document.getElementById(canvasId);
    const dataURL = canvas.toDataURL('image/png');
    
    // Salvar no orçamento
    if (canvasId === 'signature-client') {
      orcamento.assinaturas.cliente = dataURL;
    } else if (canvasId === 'signature-mechanic') {
      orcamento.assinaturas.mecanico = dataURL;
    }
    
    persist();
    alert('Assinatura salva com sucesso!');
  }
  
  function loadSignatures() {
    // Carregar assinaturas salvas
    if (orcamento.assinaturas.cliente) {
      const img = new Image();
      img.onload = function() {
        const ctx = signatureClient.getContext('2d');
        ctx.drawImage(img, 0, 0);
      };
      img.src = orcamento.assinaturas.cliente;
    }
    
    if (orcamento.assinaturas.mecanico) {
      const img = new Image();
      img.onload = function() {
        const ctx = signatureMechanic.getContext('2d');
        ctx.drawImage(img, 0, 0);
      };
      img.src = orcamento.assinaturas.mecanico;
    }
  }

  // --- FUNÇÃO PARA RENDERIZAR INFORMAÇÕES DO VEÍCULO NA INTERFACE (VISUALIZAÇÃO NORMAL) ---
  
  function renderVehicleInfo() {
    // 1. Conteúdo de Visualização Normal
    let htmlContent = '';
    
    if (Object.keys(orcamento.veiculoCompleto.informacoesBasicas).length === 0) {
      htmlContent = '<p class="muted">As informações completas do veículo aparecerão aqui após a consulta da placa.</p>';
    } else {
      // Exibição mais concisa na tela
      htmlContent += `<div class="vehicle-detail-grid">`;
      const basic = orcamento.veiculoCompleto.informacoesBasicas;
      if (basic.chassi) htmlContent += `<div class="vehicle-detail-item"><div class="vehicle-detail-label">Chassi:</div><div class="vehicle-detail-value">${basic.chassi}</div></div>`;
      if (basic.municipio) htmlContent += `<div class="vehicle-detail-item"><div class="vehicle-detail-label">Município/UF:</div><div class="vehicle-detail-value">${basic.municipio} - ${basic.uf}</div></div>`;
      if (orcamento.veiculoCompleto.situacao.situacao) htmlContent += `<div class="vehicle-detail-item"><div class="vehicle-detail-label">Situação:</div><div class="vehicle-detail-value">${orcamento.veiculoCompleto.situacao.situacao}</div></div>`;
      if (orcamento.veiculoCompleto.informacoesFipe.texto_valor) htmlContent += `<div class="vehicle-detail-item"><div class="vehicle-detail-label">Valor FIPE:</div><div class="vehicle-detail-value">${orcamento.veiculoCompleto.informacoesFipe.texto_valor}</div></div>`;
      htmlContent += `</div>`;
      htmlContent += `<div style="margin-top: 10px; text-align: center; font-style: italic; font-size: 11px;">
        Mais detalhes disponíveis na versão para impressão.
      </div>`;
    }
    
    vehicleInfoContent.innerHTML = htmlContent;
    
    // 2. Pré-renderiza a página completa para impressão (Corrigindo o problema do mobile)
    criarPaginaInformacoesVeiculo();
  }

  // --- FUNÇÃO PARA GERAR O HTML DA PÁGINA DE INFORMAÇÕES DO VEÍCULO (PARA IMPRESSÃO) ---
  
  function criarPaginaInformacoesVeiculo() {
    // ⚠️ Importante: não limpa o container principal, apenas a div de impressão.
    vehicleInfoPagePrint.innerHTML = '';
    
    if (Object.keys(orcamento.veiculoCompleto.informacoesBasicas).length === 0) {
      return; 
    }
    
    let html = `
      <h2>INFORMAÇÕES COMPLETAS DO VEÍCULO</h2>
    `;
    
    // Logo da marca (se disponível)
    if (orcamento.veiculoCompleto.informacoesBasicas.logo) {
      html += `
        <div class="vehicle-logo">
          <img src="${orcamento.veiculoCompleto.informacoesBasicas.logo}" alt="Logo ${orcamento.veiculoCompleto.informacoesBasicas.marca}">
        </div>
      `;
    }
    
    // Informações Básicas
    html += `
      <div class="vehicle-section">
        <h3>INFORMAÇÕES BÁSICAS</h3>
        <div class="vehicle-detail-grid">
    `;
    
    // Lista completa de campos a serem exibidos no PDF
    const fieldsMap = {
      // Básicas
      marca: 'Marca', modelo: 'Modelo', submodelo: 'Submodelo', versao: 'Versão',
      anoFabricacao: 'Ano Fabricação', anoModelo: 'Ano Modelo', cor: 'Cor', 
      placa: 'Placa', placaAlternativa: 'Placa Alternativa', chassi: 'Chassi', 
      origem: 'Origem', municipio: 'Município', uf: 'UF',
      // Extra
      combustivel: 'Combustível', cilindradas: 'Cilindradas', categoria: 'Categoria',
      especie: 'Espécie', tipo_veiculo: 'Tipo de Veículo', carroceria: 'Carroceria', 
      quantidade_passageiro: 'Passageiros', peso_bruto_total: 'Peso Bruto Total', 
      cap_maxima_tracao: 'Capacidade Máxima Tração'
    };
    
    // Junta as informações de diferentes seções para o loop
    const allInfo = {
        ...orcamento.veiculoCompleto.informacoesBasicas,
        ...orcamento.veiculoCompleto.informacoesExtra,
    };
    
    Object.entries(fieldsMap).forEach(([key, label]) => {
      const value = allInfo[key];
      if (value) {
        html += `
          <div class="vehicle-detail-item">
            <div class="vehicle-detail-label">${label}:</div>
            <div class="vehicle-detail-value">${value}</div>
          </div>
        `;
      }
    });
    
    html += `
        </div>
      </div>
    `;
    
    // Informações FIPE
    if (Object.keys(orcamento.veiculoCompleto.informacoesFipe).length > 0) {
      html += `
        <div class="vehicle-section">
          <h3>TABELA FIPE</h3>
          <div class="vehicle-detail-grid">
            <div class="vehicle-detail-item">
              <div class="vehicle-detail-label">Valor FIPE:</div>
              <div class="vehicle-detail-value">${orcamento.veiculoCompleto.informacoesFipe.texto_valor}</div>
            </div>
            <div class="vehicle-detail-item">
              <div class="vehicle-detail-label">Mês Referência:</div>
              <div class="vehicle-detail-value">${orcamento.veiculoCompleto.informacoesFipe.mes_referencia}</div>
            </div>
            <div class="vehicle-detail-item">
              <div class="vehicle-detail-label">Combustível FIPE:</div>
              <div class="vehicle-detail-value">${orcamento.veiculoCompleto.informacoesFipe.combustivel}</div>
            </div>
            <div class="vehicle-detail-item">
              <div class="vehicle-detail-label">Ano Modelo FIPE:</div>
              <div class="vehicle-detail-value">${orcamento.veiculoCompleto.informacoesFipe.ano_modelo}</div>
            </div>
          </div>
        </div>
      `;
    }
    
    // Situação do Veículo
    if (Object.keys(orcamento.veiculoCompleto.situacao).length > 0) {
      html += `
        <div class="vehicle-section">
          <h3>SITUAÇÃO DO VEÍCULO</h3>
          <div class="vehicle-detail-grid">
            <div class="vehicle-detail-item">
              <div class="vehicle-detail-label">Situação:</div>
              <div class="vehicle-detail-value">${orcamento.veiculoCompleto.situacao.situacao}</div>
            </div>
            <div class="vehicle-detail-item">
              <div class="vehicle-detail-label">Data da Consulta:</div>
              <div class="vehicle-detail-value">${orcamento.veiculoCompleto.situacao.dataConsulta}</div>
            </div>
          </div>
        </div>
      `;
    }
    
    html += `
      <div style="margin-top: 20px; text-align: center; font-style: italic; font-size: 11px;">
        Dados consultados via API de consulta de placas - ${new Date().toLocaleDateString('pt-BR')}
      </div>
    `;
    
    vehicleInfoPagePrint.innerHTML = html;
  }

  // --- FUNÇÕES DE IMPRESSÃO/PDF ---
  
  function prepareForPrint() {
    // Ocultar campos vazios
    const inputs = document.querySelectorAll('input, textarea');
    inputs.forEach(input => {
      if (!input.value.trim() && input.value.trim() !== '0') {
        input.classList.add('empty-field');
      } else {
        input.classList.remove('empty-field');
      }
    });
    
    // Formatar KM para exibição
    veicKm.value = formatKmForDisplay(veicKm.value);
    
    // Aplicar destaque vermelho para placa no print
    veicPlaca.classList.add('placa-destaque-print');
    
    // Definir título da página
    const orcNumFmt = String(orcamento.numero).padStart(4,'0');
    const fileNameSuffix = getFileNameSuffix();
    titleEl.textContent = `Orçamento_${orcNumFmt}${fileNameSuffix}`;
  }
  
  function restoreAfterPrint() {
    // Restaurar campos
    const inputs = document.querySelectorAll('input, textarea');
    inputs.forEach(input => {
      input.classList.remove('empty-field');
    });
    
    // Remover destaque da placa
    veicPlaca.classList.remove('placa-destaque-print');
    
    // Restaurar título original
    titleEl.textContent = originalTitle;
    
    // Restaurar KM original
    const originalKm = orcamento.veiculo.km || '';
    veicKm.value = originalKm;
  }

  // --- FUNÇÃO PARA COPIAR TODAS AS INFORMAÇÕES (BASE PARA WHATSAPP) ---

  function getFullMessageText(isWhatsapp = false) {
      persist();
      
      let texto = `*ORÇAMENTO Nº ${String(orcamento.numero).padStart(4, '0')} - ${orcamento.oficina.nome}*\n\n`;
      
      // Dados do cliente
      texto += `*DADOS DO CLIENTE:*\n`;
      if (clienteNome.value.trim()) texto += `Nome: ${clienteNome.value}\n`;
      if (clienteDoc.value.trim()) texto += `CPF/CNPJ: ${clienteDoc.value}\n`;
      if (clienteTel.value.trim()) texto += `Telefone: ${clienteTel.value}\n`;
      
      texto += `\n*DADOS DO VEÍCULO:*\n`;
      if (veicPlaca.value.trim()) texto += `Placa: ${veicPlaca.value}\n`;
      if (veicMarca.value.trim()) texto += `Marca: ${veicMarca.value}\n`;
      if (veicModelo.value.trim()) texto += `Modelo: ${veicModelo.value}\n`;
      if (veicSubmodelo.value.trim()) texto += `Submodelo: ${veicSubmodelo.value}\n`;
      if (veicVersao.value.trim()) texto += `Versão: ${veicVersao.value}\n`;
      if (veicAnoFabricacao.value.trim()) texto += `Ano Fab/Mod: ${veicAnoFabricacao.value}/${veicAnoModelo.value}\n`;
      if (veicCor.value.trim()) texto += `Cor: ${veicCor.value}\n`;
      if (veicKm.value.trim()) texto += `Km: ${veicKm.value}\n`;
      
      // Informações completas do veículo (se disponíveis)
      if (Object.keys(orcamento.veiculoCompleto.informacoesBasicas).length > 0) {
        texto += `\n*DADOS COMPLETOS (API):*\n`;
        const basic = orcamento.veiculoCompleto.informacoesBasicas;
        const extra = orcamento.veiculoCompleto.informacoesExtra;
        const fipe = orcamento.veiculoCompleto.informacoesFipe;
        const situacao = orcamento.veiculoCompleto.situacao;

        if (basic.chassi) texto += `Chassi: ${basic.chassi}\n`;
        if (basic.origem) texto += `Origem: ${basic.origem}\n`;
        if (extra.combustivel) texto += `Combustível: ${extra.combustivel}\n`;
        if (extra.cilindradas) texto += `Cilindradas: ${extra.cilindradas}\n`;
        if (extra.tipo_veiculo) texto += `Tipo: ${extra.tipo_veiculo}\n`;
        if (situacao.situacao) texto += `Situação: ${situacao.situacao}\n`;
        if (fipe.texto_valor) texto += `Valor FIPE: ${fipe.texto_valor}\n`;
        texto += `---------------------------------\n`;
      }
      
      texto += `\n*DIAGNÓSTICO:*\n${diagnostico.value || 'Não informado'}\n`;
      
      if (mecanicoResp.value.trim() || consultorResp.value.trim()) {
          texto += `\n*RESPONSÁVEIS:*\n`;
          if (mecanicoResp.value.trim()) texto += `Mecânico: ${mecanicoResp.value}\n`;
          if (consultorResp.value.trim()) texto += `Consultor: ${consultorResp.value}\n`;
      }
      
      texto += `\n*ITENS DO ORÇAMENTO:*\n`;
      
      let totalPecas = 0;
      let totalMDO = 0;
      
      if (orcamento.itens.length > 0) {
        orcamento.itens.forEach((item, index) => {
          const subtotal = item.qtd * item.valor;
          texto += `${index + 1}. ${item.descricao} (${item.tipo === 'PECA' ? 'Peça' : 'M.O.'}) - ${item.qtd}x ${fmt.format(item.valor)} = ${fmt.format(subtotal)}\n`;
          if (item.obs && !isWhatsapp) texto += `   Obs: ${item.obs}\n`; // Oculta obs na mensagem concisa
          
          if (item.tipo === 'PECA') totalPecas += subtotal;
          if (item.tipo === 'MDO') totalMDO += subtotal;
        });
      } else {
        texto += `Nenhum item adicionado\n`;
      }
      
      const totalGeral = totalPecas + totalMDO;
      
      texto += `\n*TOTAIS:*\n`;
      texto += `Peças: ${fmt.format(totalPecas)}\n`;
      texto += `Mão de Obra: ${fmt.format(totalMDO)}\n`;
      texto += `*TOTAL GERAL: ${fmt.format(totalGeral)}*\n\n`;
      
      // Condições
      texto += `*CONDIÇÕES:*\n`;
      if (prazo.value.trim()) texto += `Prazo: ${prazo.value}\n`;
      if (garantia.value.trim()) texto += `Garantia: ${garantia.value}\n`;
      if (condicoes.value.trim()) texto += `Pagamento: ${condicoes.value}\n`;
      
      if (aprovador.value.trim() || dataAprov.value.trim()) {
        texto += `\n*APROVAÇÃO:*\n`;
        if (aprovador.value.trim()) texto += `Aprovador: ${aprovador.value}\n`;
        if (dataAprov.value.trim()) texto += `Data: ${formatDateBr(dataAprov.value)}\n`;
        if (assinatura.value.trim()) texto += `Assinatura: ${assinatura.value}\n`;
      }
      
      if (obsInterna.value.trim() && !isWhatsapp) {
        texto += `\n*OBSERVAÇÕES INTERNAS:*\n${obsInterna.value}\n`;
      }
      
      texto += `\n_Orçamento válido por ${validadeInput.value} dias_\n`;
      texto += `Emissão: ${dataEmissaoEl.textContent}`;
      
      return texto;
  }

  function copiarTodasInformacoes() {
    const texto = getFullMessageText(false); // Não é WhatsApp, inclui observações internas e detalhes
    
    // Copiar para área de transferência
    navigator.clipboard.writeText(texto).then(() => {
      alert('Todas as informações do orçamento foram copiadas para a área de transferência!');
    }).catch(err => {
      console.error('Erro ao copiar:', err);
      alert('Não foi possível copiar automaticamente. Selecione e copie o texto manualmente.');
    });
  }
  
  function enviarWhatsApp() {
    // Esta função agora envia TODOS os dados, mas com observações internas omitidas.
    const mensagem = getFullMessageText(true); 
    
    // Obter o telefone e limpar. Se o telefone não tiver um DDD, o WhatsApp pode falhar.
    const tel = cleanNumber(clienteTel.value) || ''; 
    
    // Codificar a mensagem para URL
    const mensagemCodificada = encodeURIComponent(mensagem);
    
    // Criar URL do WhatsApp: se houver telefone, tenta enviar direto. Senão, abre a lista de contatos.
    const urlWhatsApp = tel.length >= 10 ? `https://wa.me/${tel}?text=${mensagemCodificada}` : `https://wa.me/?text=${mensagemCodificada}`;
    
    // Abrir WhatsApp
    window.open(urlWhatsApp, '_blank');
  }

  // Inicialização
  function init(){
    // ... (restante da sua função init) ...
    const saved = localStorage.getItem('orcamento_oficina_v1');
    if(saved){
      try{
        const loadedData = JSON.parse(saved);
        orcamento.oficina = {
            nome: loadedData.oficina.nome || 'Auto Box Mecânica',
            telefone: loadedData.oficina.telefone || '(00) 0000-0000',
            endereco: loadedData.oficina.endereco || 'Endereço da oficina',
            logoUrl: loadedData.oficina.logoUrl || ''
        };
        orcamento.responsaveis = loadedData.responsaveis || { mecanico: '', consultor: '' }; 
        orcamento.assinaturas = loadedData.assinaturas || { cliente: '', mecanico: '' };
        orcamento.veiculoCompleto = loadedData.veiculoCompleto || {
          informacoesBasicas: {},
          informacoesExtra: {},
          informacoesFipe: {},
          situacao: {}
        };

        // Certifique-se de que orcamento.veiculo.km está definido para evitar erros no restoreAfterPrint
        if(!loadedData.veiculo || typeof loadedData.veiculo.km === 'undefined') {
             loadedData.veiculo = loadedData.veiculo || {};
             loadedData.veiculo.km = '';
        }

        Object.assign(orcamento, loadedData);
        orcamento.numero = Number(loadedData.numero) || 1; 

      }catch(e){
        console.warn('Falha ao ler localStorage:', e);
        orcamento.numero = Number(localStorage.getItem('orcamento_numero') || 1);
      }
    } else {
        orcamento.numero = Number(localStorage.getItem('orcamento_numero') || 1);
    }
    
    // Inicializar canvas de assinatura
    initSignatureCanvas();
    loadSignatures();
    
    renderAll();
  }
  
  function renderAll(){
    // ... (restante da sua função renderAll) ...

    // Cabeçalho e Logo
    const hasLogo = !!orcamento.oficina.logoUrl;
    brandContainerEl.classList.toggle('has-logo', hasLogo);
    logoImgEl.src = orcamento.oficina.logoUrl || '';
    logoImgEl.style.display = hasLogo ? 'block' : 'none';

    oficinaNomeDisplay.textContent = orcamento.oficina.nome;
    oficinaInfoEl.textContent = `${orcamento.oficina.nome} • ${orcamento.oficina.telefone} • ${orcamento.oficina.endereco}`;
    orcNumEl.textContent = String(orcamento.numero).padStart(4,'0');
    dataEmissaoEl.textContent = formatDateBr(orcamento.dataEmissao);
    validadeBadge.textContent = `Validade: ${orcamento.validadeDias || 7} dias`;

    // preencher campos (inputs)
    clienteNome.value = orcamento.cliente.nome || '';
    clienteDoc.value = orcamento.cliente.doc ? maskCpfCnpj(orcamento.cliente.doc) : '';
    clienteTel.value = orcamento.cliente.tel ? maskPhone(orcamento.cliente.tel) : '';
    veicPlaca.value = orcamento.veiculo.placa ? maskPlaca(orcamento.veiculo.placa) : '';
    
    // Campos do veículo (apenas os básicos para interface)
    veicMarca.value = orcamento.veiculoCompleto.informacoesBasicas.marca || '';
    veicModelo.value = orcamento.veiculoCompleto.informacoesBasicas.modelo || '';
    veicSubmodelo.value = orcamento.veiculoCompleto.informacoesBasicas.submodelo || '';
    veicVersao.value = orcamento.veiculoCompleto.informacoesBasicas.versao || '';
    veicAnoFabricacao.value = orcamento.veiculoCompleto.informacoesBasicas.anoFabricacao || '';
    veicAnoModelo.value = orcamento.veiculoCompleto.informacoesBasicas.anoModelo || '';
    veicCor.value = orcamento.veiculoCompleto.informacoesBasicas.cor || '';
    veicKm.value = orcamento.veiculo.km || '';
    
    diagnostico.value = orcamento.diagnostico || '';
    prazo.value = orcamento.prazo || '';
    garantia.value = orcamento.garantia || '';
    condicoes.value = orcamento.condicoes || '';
    aprovador.value = orcamento.aprovacao.nome || '';
    dataAprov.value = orcamento.aprovacao.data || '';
    assinatura.value = orcamento.aprovacao.assinatura || '';
    obsInterna.value = orcamento.obsInterna || '';
    validadeInput.value = orcamento.validadeDias || 7;
    
    // Responsáveis
    mecanicoResp.value = orcamento.responsaveis.mecanico || '';
    consultorResp.value = orcamento.responsaveis.consultor || '';

    renderItens();
    calcularTotais();
    renderVehicleInfo();
  }
  
  // salvar no localStorage
  function persist(){
    orcamento.validadeDias = Number(validadeInput.value) || 7;

    orcamento.cliente = {
      nome: clienteNome.value,
      doc: cleanNumber(clienteDoc.value),
      tel: cleanNumber(clienteTel.value)
    };
    
    // Apenas dados básicos do veículo para a interface
    orcamento.veiculo = {
      placa: cleanAlphaNumeric(veicPlaca.value).toUpperCase(),
      km: cleanNumber(veicKm.value)
    };

    // Persiste os responsáveis
    orcamento.responsaveis = {
        mecanico: mecanicoResp.value,
        consultor: consultorResp.value
    };

    orcamento.diagnostico = diagnostico.value;
    orcamento.prazo = prazo.value;
    orcamento.garantia = garantia.value;
    orcamento.condicoes = condicoes.value;
    orcamento.aprovacao = {
      nome: aprovador.value,
      data: dataAprov.value,
      assinatura: assinatura.value
    };
    orcamento.obsInterna = obsInterna.value;

    if(!orcamento.dataEmissao) orcamento.dataEmissao = new Date().toISOString().slice(0,10);

    localStorage.setItem('orcamento_oficina_v1', JSON.stringify(orcamento));
    localStorage.setItem('orcamento_numero', String(orcamento.numero)); 
  }
  
  // Função para gerar o sufixo do nome do arquivo
  function getFileNameSuffix() {
    const placa = orcamento.veiculo.placa || 'SemPlaca';
    let marca = orcamento.veiculoCompleto.informacoesBasicas.marca || 'SemMarca'; 
    let modelo = orcamento.veiculoCompleto.informacoesBasicas.modelo || 'SemModelo';
    
    const cleanName = (name) => name
      .trim()
      .toUpperCase()
      .replace(/[^A-Z0-9]/g, '-') 
      .replace(/-{2,}/g, '-')
      .replace(/^-+|-+$/g, '')
      .slice(0, 30);

    marca = cleanName(marca);
    modelo = cleanName(modelo);

    let suffix = `_${placa}`;
    if (marca && marca !== 'SEMMARCA') {
        suffix += `_${marca}`;
    }
    if (modelo && modelo !== 'SEMMODELO') {
        suffix += `_${modelo}`;
    }
    return suffix;
  }

  // Função centralizada para iniciar a impressão
  function executePrint() {
      prepareForPrint();
      
      // 1. Imprime
      window.print();
      
      // 2. Incrementa o número do orçamento e salva (para a próxima OS)
      orcamento.numero++;
      localStorage.setItem('orcamento_numero', String(orcamento.numero));
      
      // 3. Restaura o estado original após um curto período de tempo
      setTimeout(() => {
          restoreAfterPrint();
          renderAll(); // Atualiza a tela com o novo número de OS
      }, 500); 
  }

  // --- FLUXO DE IMPRESSÃO: Modal de Cópia e Confirmação ---
  
  btnImprimir.addEventListener('click', () => {
      persist();
      const orcNumFmt = String(orcamento.numero).padStart(4,'0');
      const fileNameSuffix = getFileNameSuffix();
      const suggestedFileName = `Orçamento_${orcNumFmt}${fileNameSuffix}`;
      
      suggestedTitleEl.textContent = suggestedFileName;
      copyModal.style.display = 'flex';
      copyBtn.textContent = 'Copiar Título';
      copyBtn.classList.remove('copy-success', 'btn-danger');
      copyBtn.classList.add('btn-primary');
  });

  // Botão "Copiar Título" (Lógica de cópia alternativa robusta)
  copyBtn.addEventListener('click', () => {
      const titleToCopy = suggestedTitleEl.textContent;
      let success = false;
      
      try {
          const tempInput = document.createElement('textarea');
          tempInput.value = titleToCopy;
          tempInput.style.position = 'absolute';
          tempInput.style.left = '-9999px';
          document.body.appendChild(tempInput);
          
          tempInput.select();
          tempInput.setSelectionRange(0, 99999);
          
          success = document.execCommand('copy');
          
          document.body.removeChild(tempInput);
      } catch (err) {
          console.error('Falha ao usar document.execCommand:', err);
      }

      // Feedback visual
      if (success) {
          copyBtn.textContent = '✅ Copiado!';
          copyBtn.classList.remove('btn-primary');
          copyBtn.classList.add('copy-success');
      } else {
          copyBtn.textContent = '❌ Falha - Copie Manualmente';
          copyBtn.classList.remove('btn-primary');
          copyBtn.classList.add('btn-danger');
      }
      
      setTimeout(() => {
          copyBtn.textContent = 'Copiar Título';
          copyBtn.classList.add('btn-primary');
          copyBtn.classList.remove('copy-success', 'btn-danger');
      }, 2000);
  });

  // Botão "Gerar PDF" no Modal
  generatePdfBtn.addEventListener('click', () => {
      copyModal.style.display = 'none';
      executePrint();
  });

  // Cancelar / Fechar Modal de Cópia
  const closeCopyModal = () => {
      copyModal.style.display = 'none';
  };

  btnCloseCopyModal.addEventListener('click', closeCopyModal);
  btnCancelPdf.addEventListener('click', closeCopyModal);
  copyModal.addEventListener('click', (e) => {
      if (e.target === copyModal) closeCopyModal();
  });
  
  // --- Botão Zerar Contador de OS ---
  btnResetOs.addEventListener('click', () => {
      if(confirm('Tem certeza que deseja ZERAR o contador de Ordem de Serviço (OS)? O próximo orçamento começará em 0001.')) {
          orcamento.numero = 1;
          localStorage.setItem('orcamento_numero', 1);
          renderAll();
          alert('Contador de OS zerado! O próximo orçamento será o número 0001.');
      }
  });

  // --- Botão Copiar Todas as Informações ---
  btnCopyAll.addEventListener('click', copiarTodasInformacoes);

  // --- OUTROS EVENTOS ---

  // Lógica de edição/exclusão de itens
  itensBody.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const action = btn.getAttribute('data-action');
    const index = parseInt(btn.getAttribute('data-index'));

    if (action === 'edit') {
      openItemModal(index);
    } else if (action === 'delete') {
      if (confirm('Tem certeza que deseja remover este item?')) {
        orcamento.itens.splice(index, 1);
        persist();
        renderAll();
      }
    }
  });

  // Eventos de inputs principais para persistência imediata
  const allInputs = [
    validadeInput, clienteNome, clienteDoc, clienteTel, veicPlaca, veicMarca, veicModelo, 
    veicSubmodelo, veicVersao, veicAnoFabricacao, veicAnoModelo, veicCor, veicKm,
    diagnostico, prazo, garantia, condicoes, aprovador, dataAprov, assinatura, obsInterna,
    mecanicoResp, consultorResp 
  ];
  
  allInputs.forEach(el=>{
    if (el) {
      el.addEventListener('change', ()=>{ persist(); renderAll(); });
      el.addEventListener('input', ()=>{ 
          if(el.id === 'cliente-doc') el.value = maskCpfCnpj(el.value);
          if(el.id === 'cliente-tel') el.value = maskPhone(el.value);
          if(el.id === 'veic-placa') el.value = maskPlaca(el.value);
          persist(); 
      });
    }
  });

  // Evento para upload da Logo
  logoUploadInput.addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        orcamento.oficina.logoUrl = e.target.result;
        persist();
        renderAll(); 
      };
      reader.readAsDataURL(file);
    }
  });

  // Máscara e cálculo em tempo real no modal de item
  itemValorInput.addEventListener('input', () => {
    itemValorInput.value = maskMoney(itemValorInput.value);
  });

  // Evento para consulta de placa
  btnConsultarPlaca.addEventListener('click', consultarPlaca);

  // Permitir consulta com Enter no campo de placa
  veicPlaca.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      consultarPlaca();
    }
  });

  // Evento para enviar WhatsApp
  btnWhatsapp.addEventListener('click', enviarWhatsApp);

  // Eventos para assinaturas
  btnClearClient.addEventListener('click', () => clearSignature('signature-client'));
  btnSaveClient.addEventListener('click', () => saveSignature('signature-client'));
  btnClearMechanic.addEventListener('click', () => clearSignature('signature-mechanic'));
  btnSaveMechanic.addEventListener('click', () => saveSignature('signature-mechanic'));

  // Eventos de botões
  btnAddItem.addEventListener('click', () => openItemModal(-1));
  btnCloseModalItem.addEventListener('click', closeItemModal);
  btnCancelModalItem.addEventListener('click', closeItemModal);

  btnConfigOficina.addEventListener('click', openConfigModal);
  btnCloseModalConfig.addEventListener('click', closeConfigModal);
  btnCancelModalConfig.addEventListener('click', closeConfigModal);

  // Limpar
  btnLimpar.addEventListener('click', ()=>{
    if(!confirm('Limpar o orçamento atual e remover os dados salvos localmente?')) return;
    
    const nextNumber = orcamento.numero + 1;

    localStorage.removeItem('orcamento_oficina_v1');
    orcamento = {
      numero: nextNumber,
      dataEmissao: new Date().toISOString().slice(0,10),
      validadeDias: orcamento.validadeDias || 7, 
      oficina: orcamento.oficina, 
      responsaveis: { mecanico: '', consultor: '' }, 
      cliente: {},
      veiculo: {},
      diagnostico: '',
      itens: [],
      prazo: '',
      garantia: '',
      condicoes: '',
      aprovacao: {},
      obsInterna: '',
      assinaturas: {
        cliente: '',
        mecanico: ''
      },
      veiculoCompleto: {
        informacoesBasicas: {},
        informacoesExtra: {},
        informacoesFipe: {},
        situacao: {}
      }
    };
    
    localStorage.setItem('orcamento_numero', String(orcamento.numero));
    
    // Limpar assinaturas
    clearSignature('signature-client');
    clearSignature('signature-mechanic');
    
    renderAll();
  });

  // Salvar
  btnSalvar.addEventListener('click', ()=>{
    persist();
    alert('Orçamento salvo localmente (localStorage).');
  });

  // Exportar JSON
  btnExportJson.addEventListener('click', ()=>{
    persist();
    
    const orcNumFmt = String(orcamento.numero).padStart(4,'0');
    const fileNameSuffix = getFileNameSuffix();
    const fileName = `Orçamento_${orcNumFmt}${fileNameSuffix}.json`;

    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(orcamento, null, 2));
    const dl = document.createElement('a');
    dl.setAttribute('href', dataStr);
    dl.setAttribute('download', fileName);
    dl.click();
    
    // Incrementa o número para a próxima OS
    orcamento.numero++;
    localStorage.setItem('orcamento_numero', String(orcamento.numero));
    renderAll(); 

    alert(`Arquivo JSON exportado com sucesso com o nome: "${fileName}". O número da próxima OS foi atualizado.`);
  });
  
  // ao carregar
  init();
</script>
</body>
</html>
