<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Or√ßamento - Oficina Mec√¢nica</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --accent:#0f62fe;
    --muted:#6b7280;
    --success:#10b981;
    --danger:#ef4444;
    --border: #e6e9ef;
    --radius:10px;
    font-family: 'Poppins', sans-serif;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    color:#111827;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:24px;
    padding-top: 70px; 
    overflow-x: hidden;
  }

  .container{
    max-width:1100px;
    margin:0 auto;
    width: 100%;
    overflow-x: hidden;
  }

  /* ESTILOS DO CHATBOT RESPONSIVO - CORRIGIDOS */
  .chat-toggle {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--accent);
    color: white;
    border: none;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    transition: all 0.3s ease;
  }

  .chat-toggle:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
  }

  .chat-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: white;
    display: none;
    flex-direction: column;
    z-index: 1001;
  }

  .chat-container.active {
    display: flex;
  }

  .chat-header {
    background: var(--accent);
    color: white;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
    position: relative;
    min-height: 60px;
  }

  .chat-header h4 {
    margin: 0;
    font-size: 18px;
    flex: 1;
    text-align: center;
  }

  .chat-close {
    background: none;
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    padding: 8px 12px;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s;
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1002;
  }

  .chat-close:hover {
    background: rgba(255,255,255,0.2);
  }

  .chat-messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .message {
    max-width: 85%;
    padding: 12px 16px;
    border-radius: 18px;
    font-size: 16px;
    line-height: 1.4;
  }

  .message.bot {
    background: #f1f3f9;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
  }

  .message.user {
    background: var(--accent);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
  }

  .message.system {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    align-self: center;
    font-size: 14px;
    text-align: center;
    max-width: 90%;
  }

  .chat-input-container {
    padding: 15px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 8px;
    background: white;
  }

  .chat-input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: 25px;
    font-size: 16px;
    outline: none;
  }

  .chat-input:focus {
    border-color: var(--accent);
  }

  .chat-send, .chat-voice {
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .chat-voice.listening {
    background: var(--danger);
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }

  .chat-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 10px;
    justify-content: center;
  }

  .chat-btn {
    background: white;
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 10px 16px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 120px;
  }

  .chat-btn:hover {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  .chat-btn.primary {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  .chat-btn.success {
    background: var(--success);
    color: white;
    border-color: var(--success);
  }

  .chat-btn.danger {
    background: var(--danger);
    color: white;
    border-color: var(--danger);
  }

  /* BOT√ÉO DE FECHAR ALTERNATIVO NO RODAP√â PARA MOBILE */
  .chat-mobile-close {
    display: none;
    background: var(--danger);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: 600;
    margin: 10px auto;
    width: 90%;
    max-width: 200px;
    cursor: pointer;
  }

  @media (max-width: 768px) {
    body {
        padding: 15px;
        padding-top: 70px;
    }
    
    .chat-container {
        height: 100vh;
    }
    
    .chat-header {
      padding: 12px 15px;
      min-height: 56px;
    }
    
    .chat-header h4 {
      font-size: 16px;
      padding-right: 50px;
    }
    
    .chat-close {
      font-size: 24px;
      width: 40px;
      height: 40px;
      right: 8px;
    }
    
    .message {
        font-size: 16px;
        max-width: 90%;
    }
    
    .chat-input {
        font-size: 16px;
    }

    .chat-mobile-close {
      display: block;
    }

    .chat-actions {
      flex-direction: column;
      align-items: center;
    }

    .chat-btn {
      width: 100%;
      max-width: 200px;
    }
  }

  /* CORRE√á√ÉO: Bot√£o fechar vis√≠vel em modo horizontal */
  @media (max-width: 1024px) and (orientation: landscape) {
    .chat-header {
      padding: 10px 15px;
      min-height: 50px;
    }
    
    .chat-close {
      width: 36px;
      height: 36px;
      font-size: 20px;
      right: 6px;
    }
    
    .chat-header h4 {
      font-size: 16px;
      padding-right: 40px;
    }
  }

  /* Resto do CSS original */
  header.top{
    display:flex;
    gap:16px;
    align-items:center;
    margin-bottom:18px;
    flex-wrap: wrap;
  }
  .brand{
    background:linear-gradient(135deg,#ffffff,#f1f6ff);
    padding:12px 16px;
    border-radius:12px;
    border:1px solid var(--border);
    display:flex;
    flex-direction:column;
    gap:6px;
    position:relative;
    flex-grow: 1;
    min-width: 0;
  }
  .brand h1{ margin:0; font-size:18px; font-weight:700; color:var(--accent) }
  .brand small{ color:var(--muted); font-size:12px }

  .logo-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
  }
  #logo-img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: none;
  }
  .brand.has-logo {
      padding: 12px 16px 12px 80px;
      min-height: 60px;
      display: flex;
      justify-content: center;
      flex-direction: column;
  }
  .brand.has-logo .logo-container {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 50px;
      height: 50px;
      background: #f0f4ff;
      border-radius: 6px;
      border: 1px solid var(--border);
  }
  .brand.has-logo #logo-img {
      display: block;
      width: 100%;
      height: 100%;
      object-fit: scale-down;
  }

  .meta{
    margin-left:auto;
    text-align:right;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    min-width: 150px;
    flex-shrink: 0;
  }
  .meta .number{ font-weight:700; font-size:16px }
  .meta small{ display:block; color:var(--muted); font-size:12px }

  .fixed-actions {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 1010;
      display: flex;
      gap: 8px;
  }
  .fixed-actions button, .fixed-actions label {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      padding: 0;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 10px rgba(12,20,50,0.15);
      flex-shrink: 0;
  }

  #btn-select-logo {
      background: var(--accent);
      color: #fff;
      font-size: 18px;
  }
  #btn-config-oficina {
      background: var(--muted);
      color: #fff;
  }
  
  .fixed-actions button:hover, .fixed-actions label:hover {
      box-shadow: 0 6px 12px rgba(12,20,50,0.25);
      transform: scale(1.05);
  }

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:16px;
    margin-bottom:16px;
    box-shadow: 0 1px 4px rgba(12,20,50,0.04);
    overflow: hidden;
  }

  .row{ display:flex; gap:12px; flex-wrap:wrap; }
  .col{ flex:1; min-width:220px; }

  .info-group .row .col {
      flex: 1;
      min-width: 150px;
  }
  .info-group .row .col.col-placa, 
  .info-group .row .col.col-ano, 
  .info-group .row .col.col-cor, 
  .info-group .row .col.col-km {
      min-width: 90px;
      flex: 0.3;
  }
  .info-group .row .col.col-marca {
      min-width: 110px;
      flex: 0.5;
  }
  .info-group .row .col.col-modelo {
      min-width: 130px;
      flex: 0.7;
  }
  .info-group .row .col.col-tel, 
  .info-group .row .col.col-doc {
      min-width: 130px;
      flex: 0.7;
  }

  .placa-consulta-container {
    display: flex;
    gap: 8px;
    align-items: flex-end;
    flex-wrap: wrap;
  }
  .placa-consulta-container .col {
    flex: 1;
    min-width: 120px;
  }
  .placa-consulta-container button {
    height: 42px;
    margin-bottom: 6px;
    padding: 10px 16px;
    white-space: nowrap;
    font-size: 14px;
    font-weight: 600;
    flex-shrink: 0;
  }

  .placa-destaque {
    border: 2px solid #dc2626 !important;
    background-color: #fef2f2 !important;
    color: #dc2626 !important;
    font-weight: 700 !important;
  }
  .placa-destaque::placeholder {
    color: #fca5a5 !important;
  }
  .btn-placa-destaque {
    background: #dc2626 !important;
    color: white !important;
    border: 2px solid #dc2626 !important;
    font-weight: 700 !important;
  }
  .btn-placa-destaque:hover {
    background: #b91c1c !important;
    border-color: #b91c1c !important;
  }
  
  label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
  input[type="text"], input[type="number"], input[type="date"], textarea, select{
    width:100%;
    padding:10px 12px;
    border-radius:8px;
    border:1px solid var(--border);
    font-size:14px;
    background:#fff;
    max-width: 100%;
    box-sizing: border-box;
  }
  textarea{ min-height:64px; resize:vertical; }

  .small{ font-size:12px; color:var(--muted) }

  table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:14px;}
  table thead th{
    text-align:left;
    font-weight:600;
    padding:10px;
    border-bottom:1px solid var(--border);
  }
  table tbody td{
    padding:10px;
    border-bottom:1px dashed #eee;
    vertical-align:middle;
  }
  .text-right{ text-align:right }
  .muted{ color:var(--muted); font-size:13px }
  
  .valor-destaque {
      font-weight: 600;
      color: var(--accent);
  }

  .actions{ display:flex; gap:8px; align-items:center; flex-wrap: wrap; }

  button{
    padding:10px 14px;
    border-radius:8px;
    border:0;
    cursor:pointer;
    font-weight:600;
    transition: all 0.2s ease;
    font-size: 14px;
    min-height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .btn-primary{ background:var(--accent); color:#fff; }
  .btn-primary:hover { opacity: 0.9; }
  .btn-ghost{ background:transparent; border:1px solid var(--border); color:#111827; }
  .btn-ghost:hover { background: #f0f4ff; }
  .btn-danger{ background:var(--danger); color:#fff; }
  .btn-danger:hover { opacity: 0.9; }
  .btn-success{ background:var(--success); color:#fff; }

  .totals-wrapper {
    display: flex;
    justify-content: flex-end;
    margin-top: 12px;
  }
  .totals{
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }
  .totals .box{
    background:#f8fafc;
    border:1px solid var(--border);
    padding:10px 14px;
    border-radius:8px;
    min-width: 150px;
    flex: 1;
    text-align:right;
    margin-bottom: 0;
  }
  .totals .box .label{ color:var(--muted); font-size:13px }
  .totals .box .value{ font-weight:700; font-size:18px; color:var(--accent); }

  #vehicle-info-content {
      padding: 0;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-top: 10px;
      overflow: hidden;
  }

  #vehicle-logo-display {
      text-align: center;
      padding: 10px 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f8fafc;
      border-bottom: 1px solid var(--border);
      max-width: 100%;
      overflow: hidden;
  }
  #vehicle-logo-display img {
      max-height: 50px;
      max-width: 120px;
      height: auto;
      width: auto;
      object-fit: contain;
  }

  .vehicle-detail-grid-display {
      display: grid;
      grid-template-columns: 1fr;
      width: 100%;
      overflow: hidden;
  }

  @media (min-width: 600px) {
      .vehicle-detail-grid-display {
          grid-template-columns: repeat(2, 1fr);
      }
  }

  .vehicle-detail-item-display {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 10px 16px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
      width: 100%;
      box-sizing: border-box;
  }
  .vehicle-detail-item-display:nth-child(even) {
      background: #f8fafc;
  }
  .vehicle-detail-item-display:last-child {
      border-bottom: none;
  }

  .vehicle-detail-label-display {
      font-weight: 600;
      color: var(--muted);
      white-space: nowrap;
      padding-right: 10px;
      flex-shrink: 0;
      width: 45%;
      text-align: left;
  }
  .vehicle-detail-value-display {
      font-weight: 500;
      color: #111827;
      text-align: right;
      word-break: break-word;
      width: 55%;
  }

  .signature-section {
    margin-top: 16px;
    border-top: 1px solid var(--border);
    padding-top: 16px;
  }
  .signature-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-top: 12px;
  }
  .signature-box {
    flex: 1;
    min-width: 280px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    background: #fafbfc;
  }
  .signature-box h4 {
    margin: 0 0 12px 0;
    font-size: 14px;
    color: var(--muted);
    text-align: center;
  }
  .signature-canvas {
    width: 100%;
    height: 120px;
    border: 1px dashed var(--border);
    border-radius: 6px;
    background: white;
    cursor: crosshair;
    display: block;
  }
  .signature-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
    justify-content: center;
  }
  .signature-actions button {
    font-size: 12px;
    padding: 6px 10px;
  }

  .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      overflow-y: auto;
  }
  .modal-content {
      background: var(--card);
      padding: 24px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      animation: fadeIn 0.3s ease-out;
      margin: 20px 0;
  }
  
  .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
  }
  .modal-header h3 { margin: 0; }
  .modal-close {
      background: transparent;
      font-size: 24px;
      line-height: 1;
      padding: 0;
      width: 24px;
      height: 24px;
      color: var(--muted);
  }
  .modal-close:hover {
      color: var(--danger);
  }

  #copy-modal .modal-content {
    max-width: 450px;
  }
  #suggested-title {
    background: var(--bg);
    border: 1px dashed var(--accent);
    padding: 12px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    word-break: break-all;
    margin-bottom: 16px;
    color: var(--accent);
  }
  #copy-modal .modal-footer {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
  }
  #copy-btn {
    font-weight: 700;
    padding-left: 16px;
    padding-right: 16px;
  }
  #copy-btn.copy-success {
      background: var(--success);
      color: #fff;
  }

  @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
  }

  footer { 
      margin-top:18px; 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      gap:12px; 
      flex-wrap:wrap; 
  }
  #btn-reset-os {
      color: var(--danger);
      background: #fef2f2;
      border: 1px solid var(--danger);
  }
  #btn-reset-os:hover {
      background: var(--danger);
      color: #fff;
  }

  /* CORRE√á√ÉO: Estilos para ocultar campos vazios na impress√£o */
  @media print{
    .no-print, .chat-container, .chat-toggle { display: none !important; }
    
    /* Oculta campos vazios */
    input.empty-field, textarea.empty-field, 
    .empty-section, .empty-card,
    .signature-box:has(canvas:not([data-has-signature])) {
      display: none !important;
    }
    
    /* Oculta linhas da tabela vazias */
    table tbody tr:has(td:empty) {
      display: none !important;
    }
    
    /* Oculta se√ß√µes de assinatura sem assinatura */
    .signature-box:not(:has(canvas[data-has-signature])) {
      display: none !important;
    }
  }
</style>
</head>
<body>
  
  <!-- Bot√£o para abrir o chat -->
  <button id="open-chat" class="chat-toggle no-print">üí¨</button>

  <!-- Container do Chat em tela cheia -->
  <div id="chat-container" class="chat-container">
    <div class="chat-header">
      <h4>ü§ñ Assistente de Or√ßamento</h4>
      <button class="chat-close" id="close-chat" title="Fechar chat">√ó</button>
    </div>
    <div id="chat-messages" class="chat-messages"></div>
    <div class="chat-input-container">
      <input type="text" id="chat-input" class="chat-input" placeholder="Digite sua resposta ou use o microfone..." autocomplete="off">
      <button id="chat-voice" class="chat-voice" title="Falar">üé§</button>
      <button id="send-chat" class="chat-send">‚û§</button>
    </div>
    <!-- BOT√ÉO ALTERNATIVO PARA FECHAR NO MOBILE -->
    <button class="chat-mobile-close" id="close-chat-mobile">Fechar Assistente</button>
  </div>

  <div class="fixed-actions no-print">
      <button id="btn-config-oficina" title="Configura√ß√µes da Oficina">‚öôÔ∏è</button>
      
      <label for="logo-upload" id="btn-select-logo" title="Adicionar / Alterar Logo">üñºÔ∏è</label>
      <input type="file" id="logo-upload" accept="image/*" style="display:none;">
  </div>

  <div class="container">
    <!-- Conte√∫do original da aplica√ß√£o 1 -->
    <header class="top">
      <div class="brand" id="brand-container">
        <div class="logo-container">
            <img id="logo-img" src="" alt="Logo da Oficina">
        </div>
        <h1 id="oficina-nome-display">Oficina Mec√¢nica</h1>
        <small id="oficina-info">Nome da Oficina ‚Ä¢ Telefone ‚Ä¢ Endere√ßo</small>
      </div>

      <div class="meta">
        <div class="number">OR√áAMENTO N¬∫ <span id="orc-num">0001</span></div>
        <small>Data emiss√£o: <span id="data-emissao"></span></small>
        <small class="muted" id="validade-badge">Validade: 7 dias</small>
      </div>
    </header>

    <div class="card info-group">
      <h3 style="margin:0 0 8px 0">Dados do Cliente e do Ve√≠culo</h3>
      
      <div class="row">
        <div class="col col-nome">
          <label>Nome</label>
          <input id="cliente-nome" type="text" placeholder="Nome completo">
        </div>
        <div class="col col-doc">
          <label>CPF / CNPJ</label>
          <input id="cliente-doc" type="text" placeholder="000.000.000-00" inputmode="numeric">
        </div>
        <div class="col col-tel">
          <label>Telefone / WhatsApp</label>
          <input id="cliente-tel" type="text" placeholder="(00) 9 0000-0000" inputmode="tel">
        </div>
        
        <div class="placa-consulta-container">
          <div class="col col-placa">
            <label>Placa</label>
            <input id="veic-placa" type="text" placeholder="ABC1A23" maxlength="8" inputmode="text" style="text-transform: uppercase;" class="placa-destaque">
          </div>
          <button class="btn-placa-destaque" id="btn-consultar-placa" title="Consultar dados da placa">üîç Buscar Placa</button>
        </div>
      </div>

      <h3 style="margin:12px 0 8px 0">Informa√ß√µes B√°sicas do Ve√≠culo</h3>
      <div class="row">
        <div class="col col-marca">
          <label>Marca</label>
          <input id="veic-marca" type="text" placeholder="Ex: FIAT">
        </div>
        <div class="col col-modelo">
          <label>Modelo</label>
          <input id="veic-modelo" type="text" placeholder="Ex: IDEA ADVENTURE 1.8">
        </div>
        <div class="col col-ano">
          <label>Ano Fabrica√ß√£o</label>
          <input id="veic-ano-fabricacao" type="text" placeholder="2011" inputmode="numeric" pattern="[0-9]*">
        </div>
        <div class="col">
          <label>Ano Modelo</label>
          <input id="veic-ano-modelo" type="text" placeholder="2012" inputmode="numeric" pattern="[0-9]*">
        </div>
      </div>
      
      <div class="row" style="margin-top: 12px;">
        <div class="col col-cor">
          <label>Cor</label>
          <input id="veic-cor" type="text" placeholder="Ex: CINZA">
        </div>
        <div class="col col-km">
          <label>Km</label>
          <input id="veic-km" type="text" placeholder="123456" maxlength="6" inputmode="decimal" pattern="[0-9.,]*">
        </div>
        <div class="col" style="flex: 1 1 90px; visibility: hidden;"></div>
        <div class="col" style="flex: 1 1 90px; visibility: hidden;"></div>
      </div>

      <h3 style="margin:12px 0 8px 0">Diagn√≥stico</h3>
      <div>
        <textarea id="diagnostico" placeholder="Descreva o problema relatado e observa√ß√µes do mec√¢nico"></textarea>
      </div>
    </div>

    <div id="vehicle-info-container" class="card">
      <h3 style="margin:0 0 8px 0">Informa√ß√µes Completas do Ve√≠culo (API)</h3>
      <div id="vehicle-info-content">
        <p class="muted" style="padding: 16px;">As informa√ß√µes completas do ve√≠culo aparecer√£o aqui ap√≥s a consulta da placa.</p>
      </div>
      <div id="vehicle-info-page-print" class="vehicle-info-page"></div>
    </div>

    <div id="vehicle-info-pdf-container" style="display: none;"></div>

    <div class="card">
        <h3 style="margin:0 0 8px 0">Respons√°veis</h3>
        <div class="row">
            <div class="col">
                <label>Mec√¢nico Respons√°vel</label>
                <input id="mecanico-resp" type="text" placeholder="Nome do Mec√¢nico">
            </div>
            <div class="col">
                <label>Consultor Respons√°vel</label>
                <input id="consultor-resp" type="text" placeholder="Nome do Consultor / Vendedor">
            </div>
        </div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
        <h3 style="margin:0">Itens (Pe√ßas e Servi√ßos)</h3>
        <div class="no-print">
          <button class="btn-primary" id="btn-add-item" title="Adicionar item">+ Adicionar item</button>
        </div>
      </div>

      <table id="tabela-itens" aria-label="Tabela de itens do or√ßamento">
        <thead>
          <tr>
            <th style="width:6%">#</th>
            <th style="width:36%">Descri√ß√£o</th>
            <th style="width:12%">Qtd</th>
            <th style="width:14%">Valor Unit.</th>
            <th style="width:14%">Subtotal</th>
            <th style="width:18%" class="no-print">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="itens-body"></tbody>
      </table>

      <div class="totals-wrapper">
        <div class="totals">
            <div class="box">
            <div class="label">Total pe√ßas</div>
            <div class="value" id="total-pecas">R$ 0,00</div>
            </div>
            <div class="box">
            <div class="label">Total m√£o de obra</div>
            <div class="value" id="total-mdo">R$ 0,00</div>
            </div>
            <div class="box">
            <div class="label">TOTAL GERAL</div>
            <div class="value" id="total-geral">R$ 0,00</div>
            </div>
        </div>
      </div>
      <div style="display:flex; justify-content:space-between; gap:12px; margin-top:12px; align-items:center; flex-wrap:wrap;">
        <div class="muted">Observa√ß√£o: valores podem variar caso sejam identificados novos servi√ßos ap√≥s abertura.</div>
        <div class="no-print actions">
          <button class="btn-danger" id="btn-limpar">Limpar Tudo</button>
          <button class="btn-primary" id="btn-imprimir">Gerar PDF / Imprimir</button>
          <button class="btn-success" id="btn-whatsapp">Enviar WhatsApp</button>
          <button class="btn-success" id="btn-copy-all">Copiar Tudo</button>
          <button class="btn-ghost" id="btn-reset-os">Zerar Contador OS</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>Prazo estimado</label>
          <input type="text" id="prazo" placeholder="Ex: 2 dias √∫teis">
        </div>
        <div class="col">
          <label>Validade do or√ßamento</label>
          <input type="number" id="validade" min="1" value="7" inputmode="numeric"> <span class="small">dias</span>
        </div>
        <div class="col">
          <label>Garantia servi√ßo</label>
          <input type="text" id="garantia" placeholder="Ex: 90 dias - servi√ßos">
        </div>
      </div>

      <div style="margin-top:12px;">
        <label>Condi√ß√µes de pagamento</label>
        <input type="text" id="condicoes" placeholder="Ex: √Ä vista PIX / Cart√£o / Parcelado">
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">Aprova√ß√£o do Cliente</h3>
      <div class="row">
        <div class="col">
          <label>Nome do aprovador</label>
          <input id="aprovador" type="text" placeholder="Nome completo">
        </div>
        <div class="col">
          <label>Data de aprova√ß√£o</label>
          <input id="data-aprov" type="date">
        </div>
        <div class="col">
          <label>Assinatura respons√°vel</label>
          <input id="assinatura" type="text" placeholder="Nome para registrar como assinatura">
        </div>
      </div>
      
      <div class="signature-section">
        <h4>Assinaturas</h4>
        <div class="signature-container">
          <div class="signature-box">
            <h4>Assinatura do Cliente</h4>
            <canvas id="signature-client" class="signature-canvas"></canvas>
            <div class="signature-actions no-print">
              <button class="btn-ghost" id="btn-clear-client">Limpar</button>
              <button class="btn-primary" id="btn-save-client">Salvar Assinatura</button>
            </div>
          </div>
          <div class="signature-box">
            <h4>Assinatura do Mec√¢nico</h4>
            <canvas id="signature-mechanic" class="signature-canvas"></canvas>
            <div class="signature-actions no-print">
              <button class="btn-ghost" id="btn-clear-mechanic">Limpar</button>
              <button class="btn-primary" id="btn-save-mechanic">Salvar Assinatura</button>
            </div>
          </div>
        </div>
      </div>
      
      <div style="margin-top:10px;" class="muted">Ao assinar, o cliente concorda com os termos do or√ßamento e autoriza o in√≠cio dos servi√ßos mediante aprova√ß√£o.</div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">Observa√ß√µes internas</h3>
      <textarea id="obs-interna" placeholder="Observa√ß√µes para uso interno (data in√≠cio, notas)"></textarea>
    </div>

    <footer>
      <div class="small muted">Or√ßamento gerado pelo sistema ‚Ä¢ Recomenda-se revisar valores antes de aprovar.</div>
      <div class="actions no-print">
        <button class="btn-ghost" id="btn-export-json">Baixar Dados (JSON)</button>
      </div>
    </footer>
  </div>

  <!-- MODAIS -->
  <div class="modal-overlay" id="item-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Adicionar Novo Item</h3>
        <button class="modal-close" id="btn-close-modal-item">√ó</button>
      </div>
      <div class="modal-body" style="display:flex; flex-direction:column; gap:12px;">
        <div>
          <label>Descri√ß√£o (Pe√ßa/Servi√ßo)</label>
          <input id="item-descricao" type="text" placeholder="Ex: √ìleo de motor 5w40 / Troca de Correia">
        </div>
        <div>
          <label>Tipo</label>
          <select id="item-tipo">
            <option value="PECA">Pe√ßa</option>
            <option value="MDO">M√£o de Obra (Servi√ßo)</option>
          </select>
        </div>
        <div class="row">
            <div class="col" style="min-width: 100px; flex: 1;">
                <label>Quantidade</label>
                <input id="item-qtd" type="text" inputmode="decimal" pattern="[0-9.,]*" value="1">
            </div>
            <div class="col" style="min-width: 150px; flex: 2;">
                <label>Valor Unit√°rio (R$)</label>
                <input id="item-valor" type="text" inputmode="decimal" placeholder="R$ 0,00" pattern="[0-9.,]*">
            </div>
        </div>
        <div>
          <label>Observa√ß√µes do Item (Opcional)</label>
          <textarea id="item-obs" placeholder="Detalhes t√©cnicos, c√≥digo da pe√ßa, etc."></textarea>
        </div>
      </div>
      <div style="margin-top:20px; text-align:right;">
        <button class="btn-ghost" id="btn-cancel-modal-item">Cancelar</button>
        <button class="btn-primary" id="btn-save-item">Salvar Item</button>
      </div>
    </div>
  </div>

  <!-- Modal de Configura√ß√µes -->
  <div class="modal-overlay" id="config-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Configura√ß√µes da Oficina</h3>
        <button class="modal-close" id="btn-close-modal-config">√ó</button>
      </div>
      <div class="modal-body" style="display:flex; flex-direction:column; gap:12px;">
        <div>
          <label>Nome da Oficina</label>
          <input id="config-nome" type="text" placeholder="Nome da sua oficina">
        </div>
        <div>
          <label>Telefone</label>
          <input id="config-telefone" type="text" placeholder="(00) 9 0000-0000" inputmode="tel">
        </div>
        <div>
          <label>Endere√ßo</label>
          <textarea id="config-endereco" placeholder="Endere√ßo completo da oficina"></textarea>
        </div>
      </div>
      <div style="margin-top:20px; text-align:right;">
        <button class="btn-ghost" id="btn-cancel-modal-config">Cancelar</button>
        <button class="btn-primary" id="btn-save-config">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Copiar T√≠tulo -->
  <div class="modal-overlay" id="copy-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Copiar T√≠tulo do Or√ßamento</h3>
        <button class="modal-close" id="btn-close-copy-modal">√ó</button>
      </div>
      <div class="modal-body">
        <p>Copie o t√≠tulo abaixo para usar no PDF:</p>
        <div id="suggested-title"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-ghost" id="btn-cancel-pdf">Cancelar</button>
        <button class="btn-primary" id="copy-btn">Copiar T√≠tulo</button>
        <button class="btn-success" id="generate-pdf-btn">Gerar PDF</button>
      </div>
    </div>
  </div>

<script>
  // =============================================
  // SISTEMA DE CHATBOT IA AVAN√áADO CORRIGIDO
  // =============================================

  class OrcamentoChatbot {
    constructor() {
      this.currentStep = 0;
      this.conversationHistory = [];
      this.userData = {};
      this.isListening = false;
      this.recognition = null;
      this.currentItem = null;
      
      // CORRE√á√ÉO: Adicionadas perguntas sobre CPF e KM
      this.steps = [
        {
          question: "üöó **Vamos criar um or√ßamento!** Qual a **placa do ve√≠culo**?",
          field: 'placa',
          type: 'placa',
          skipText: "Pular placa",
          voiceHint: "Diga a placa do ve√≠culo, por exemplo: ABC um A dois tr√™s"
        },
        {
          question: "üë§ Qual o **nome do cliente**?",
          field: 'clienteNome',
          type: 'text',
          skipText: "Pular nome",
          voiceHint: "Diga o nome completo do cliente"
        },
        {
          question: "üìÑ Qual o **CPF ou CNPJ** do cliente?",
          field: 'clienteDoc',
          type: 'documento',
          skipText: "Pular documento",
          voiceHint: "Diga o CPF ou CNPJ do cliente"
        },
        {
          question: "üìû Qual o **telefone** do cliente?",
          field: 'clienteTelefone', 
          type: 'telefone',
          skipText: "Pular telefone",
          voiceHint: "Diga o telefone com DDD, por exemplo: onze nove nove nove oito sete seis cinco quatro tr√™s"
        },
        {
          question: "üìä Qual a **quilometragem atual** do ve√≠culo?",
          field: 'veiculoKm',
          type: 'km',
          skipText: "Pular quilometragem",
          voiceHint: "Diga a quilometragem atual do ve√≠culo"
        },
        {
          question: "üîß Qual o **diagn√≥stico** ou problema relatado?",
          field: 'diagnostico',
          type: 'textarea',
          skipText: "Pular diagn√≥stico",
          voiceHint: "Descreva o problema do ve√≠culo"
        },
        {
          question: "üõ†Ô∏è Vamos adicionar **pe√ßas e servi√ßos**. Digite o **nome do primeiro item** ou diga 'pr√≥ximo' para pular:",
          field: 'itens',
          type: 'itens',
          skipText: "Pular itens",
          voiceHint: "Diga o nome do servi√ßo ou pe√ßa, por exemplo: troca de √≥leo do motor"
        },
        {
          question: "‚è∞ Qual o **prazo estimado** para execu√ß√£o?",
          field: 'prazo',
          type: 'text',
          skipText: "Pular prazo",
          voiceHint: "Diga o prazo, por exemplo: tr√™s dias √∫teis"
        },
        {
          question: "üõ°Ô∏è Qual a **garantia** oferecida?",
          field: 'garantia', 
          type: 'text',
          skipText: "Pular garantia",
          voiceHint: "Diga a garantia, por exemplo: noventa dias para servi√ßos"
        },
        {
          question: "üí≥ Quais as **condi√ß√µes de pagamento**?",
          field: 'condicoes',
          type: 'text',
          skipText: "Pular condi√ß√µes",
          voiceHint: "Diga as condi√ß√µes de pagamento"
        },
        {
          question: "‚úÖ **Or√ßamento completo!** O que deseja fazer?",
          field: 'finalizacao',
          type: 'acoes',
          skipText: "Continuar editando"
        }
      ];

      this.initVoiceRecognition();
    }

    initVoiceRecognition() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        this.recognition = new SpeechRecognition();
        this.recognition.continuous = false;
        this.recognition.interimResults = false;
        this.recognition.lang = 'pt-BR';

        this.recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          this.processVoiceInput(transcript);
        };

        this.recognition.onerror = (event) => {
          console.error('Erro no reconhecimento de voz:', event.error);
          this.addBotMessage("‚ùå **N√£o consegui entender.** Tente digitar ou falar novamente.");
          this.isListening = false;
          this.updateVoiceButton();
        };

        this.recognition.onend = () => {
          this.isListening = false;
          this.updateVoiceButton();
        };
      }
    }

    processVoiceInput(transcript) {
      this.addUserMessage(transcript);
      
      const currentStep = this.getCurrentQuestion();
      
      if (currentStep.type === 'itens' && this.currentItem) {
        if (!this.currentItem.valor) {
          this.processItemValor(transcript);
        } else if (!this.currentItem.quantidade) {
          this.processItemQuantidade(transcript);
        }
      } else if (transcript.toLowerCase().includes('pr√≥ximo') || transcript.toLowerCase().includes('proximo')) {
        this.skipStepAndContinue();
      } else if (transcript.toLowerCase().includes('voltar')) {
        this.goBack();
      } else {
        this.processAnswer(transcript);
      }
    }

    startListening() {
      if (this.recognition && !this.isListening) {
        this.isListening = true;
        this.updateVoiceButton();
        this.recognition.start();
        this.addBotMessage("üé§ **Ouvindo...** Fale agora!");
      }
    }

    stopListening() {
      if (this.recognition && this.isListening) {
        this.recognition.stop();
        this.isListening = false;
        this.updateVoiceButton();
      }
    }

    updateVoiceButton() {
      const voiceBtn = document.getElementById('chat-voice');
      if (voiceBtn) {
        voiceBtn.textContent = this.isListening ? '‚èπÔ∏è' : 'üé§';
        voiceBtn.classList.toggle('listening', this.isListening);
      }
    }

    getCurrentQuestion() {
      return this.steps[this.currentStep];
    }

    processAnswer(answer) {
      const currentStep = this.getCurrentQuestion();
      this.conversationHistory.push({
        step: currentStep.field,
        question: currentStep.question,
        answer: answer
      });

      switch(currentStep.type) {
        case 'placa':
          this.processPlaca(answer);
          break;
        case 'documento':
          this.processDocumento(answer);
          break;
        case 'km':
          this.processKm(answer);
          break;
        case 'itens':
          this.processItem(answer);
          break;
        case 'acoes':
          this.processAcao(answer);
          break;
        default:
          this.updateField(currentStep.field, answer);
      }

      if (currentStep.type !== 'itens' && currentStep.field !== 'finalizacao') {
        this.currentStep++;
      }

      return this.getCurrentQuestion();
    }

    processPlaca(placa) {
      if (placa && placa.trim()) {
        const placaConvertida = this.convertWordsToNumbers(placa);
        const placaLimpa = placaConvertida.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
        
        document.getElementById('veic-placa').value = this.formatPlaca(placaLimpa);
        persist();
        
        this.addBotMessage(`üîç **Consultando dados da placa ${placaLimpa}...**`);
        
        setTimeout(() => {
          if (typeof consultarPlaca === 'function') {
            consultarPlaca();
          }
          this.addBotMessage("‚úÖ **Dados do ve√≠culo preenchidos automaticamente!**");
        }, 1500);
      }
    }

    processDocumento(documento) {
      if (documento && documento.trim()) {
        const docConvertido = this.convertWordsToNumbers(documento);
        const docLimpo = docConvertido.replace(/[^0-9]/g, '');
        
        let docFormatado = docLimpo;
        if (docLimpo.length <= 11) {
          docFormatado = docLimpo.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        } else {
          docFormatado = docLimpo.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
        }
        
        document.getElementById('cliente-doc').value = docFormatado;
        persist();
        this.addBotMessage("‚úÖ **Documento registrado com sucesso!**");
      }
    }

    processKm(km) {
      if (km && km.trim()) {
        const kmConvertido = this.convertWordsToNumbers(km);
        const kmLimpo = kmConvertido.replace(/[^0-9]/g, '');
        
        document.getElementById('veic-km').value = kmLimpo;
        persist();
        this.addBotMessage("‚úÖ **Quilometragem registrada com sucesso!**");
      }
    }

    convertWordsToNumbers(text) {
      const numberMap = {
        'zero': '0', 'um': '1', 'dois': '2', 'tr√™s': '3', 'quatro': '4',
        'cinco': '5', 'seis': '6', 'sete': '7', 'oito': '8', 'nove': '9'
      };
      
      return text.replace(
        new RegExp(Object.keys(numberMap).join('|'), 'gi'),
        matched => numberMap[matched.toLowerCase()] || matched
      );
    }

    processItem(descricao) {
      if (descricao && descricao.trim() && !descricao.toLowerCase().includes('pr√≥ximo') && !descricao.toLowerCase().includes('proximo')) {
        this.currentItem = { descricao: descricao };
        this.addBotMessage(`üíµ Qual o **valor** para **${descricao}**?`);
      } else {
        this.skipStepAndContinue();
      }
    }

    processItemValor(valor) {
      if (this.currentItem) {
        const valorNumerico = valor.replace(/[^\d,]/g, '').replace(',', '.');
        this.currentItem.valor = parseFloat(valorNumerico) || 0;
        
        if (this.currentItem.valor > 0) {
          this.addBotMessage(`üì¶ Qual a **quantidade** para **${this.currentItem.descricao}**?`);
        } else {
          this.addBotMessage("‚ùå **Valor inv√°lido.** Digite o valor novamente:");
        }
      }
    }

    processItemQuantidade(qtd) {
      if (this.currentItem) {
        const qtdNumerica = qtd.replace(/\D/g, '');
        this.currentItem.quantidade = parseInt(qtdNumerica) || 1;
        this.finalizarItem();
      }
    }

    finalizarItem() {
      if (this.currentItem && this.currentItem.descricao && this.currentItem.valor && this.currentItem.quantidade) {
        this.adicionarItemTabela(this.currentItem.descricao, this.currentItem.quantidade, this.currentItem.valor);
        this.addBotMessage(`‚úÖ **Item adicionado!**\n\n${this.currentItem.quantidade}x ${this.currentItem.descricao} - R$ ${this.currentItem.valor.toFixed(2)}`);
        
        this.addBotMessage("üìù Quer adicionar **mais um item**? Digite o nome ou **'pr√≥ximo'** para continuar.");
        this.currentItem = null;
      }
    }

    adicionarItemTabela(descricao, quantidade, valor) {
      const novoItem = {
        descricao: descricao,
        tipo: descricao.toLowerCase().includes('m√£o de obra') || descricao.toLowerCase().includes('servi√ßo') ? 'MDO' : 'PECA',
        qtd: parseFloat(quantidade),
        valor: parseFloat(valor),
        obs: 'Adicionado via assistente'
      };

      orcamento.itens.push(novoItem);
      persist();
      renderAll();
    }

    processAcao(resposta) {
      resposta = resposta.toLowerCase();
      if (resposta.includes('pdf') || resposta.includes('imprimir') || resposta.includes('gerar')) {
        this.addBotMessage("üìÑ **Gerando PDF...**");
        this.gerarPDFDiretamente();
      } else if (resposta.includes('whatsapp') || resposta.includes('zap')) {
        this.addBotMessage("üí¨ **Preparando para enviar no WhatsApp...**");
        setTimeout(() => btnWhatsapp.click(), 1000);
      } else if (resposta.includes('copiar') || resposta.includes('texto')) {
        this.addBotMessage("üìã **Texto copiado para a √°rea de transfer√™ncia!**");
        setTimeout(() => btnCopyAll.click(), 500);
      } else if (resposta.includes('assinar') || resposta.includes('assinatura')) {
        this.addBotMessage("üñäÔ∏è **Encaminhando para assinaturas...**");
        setTimeout(() => {
          const signatureSection = document.querySelector('.signature-section');
          if (signatureSection) {
            signatureSection.scrollIntoView({ behavior: 'smooth' });
          }
        }, 500);
      } else if (resposta.includes('voltar') || resposta.includes('ajustar')) {
        this.addBotMessage("üîô **Voltando para edi√ß√£o...** Qual campo deseja ajustar?");
        this.currentStep = 0;
        setTimeout(() => this.askCurrentQuestion(), 1000);
      } else if (resposta.includes('adicionar') || resposta.includes('mais') || resposta.includes('item')) {
        this.addBotMessage("üõ†Ô∏è **Vamos adicionar mais um item!** Digite o nome do pr√≥ximo item:");
        this.currentStep = 6; // Volta para o passo de itens
      } else {
        this.addBotMessage("‚ùì **Comando n√£o reconhecido.** Escolha uma das op√ß√µes abaixo:");
        this.showFinalActions();
      }
    }

    gerarPDFDiretamente() {
      persist();
      setTimeout(() => {
        btnImprimir.click();
        this.addBotMessage("‚úÖ **PDF gerado com sucesso!** Verifique a janela de impress√£o do seu navegador.");
      }, 1000);
    }

    updateField(field, value) {
      if (value && value.trim()) {
        this.userData[field] = value;
        
        const fieldMap = {
          'clienteNome': 'cliente-nome',
          'clienteTelefone': 'cliente-tel',
          'diagnostico': 'diagnostico',
          'prazo': 'prazo',
          'garantia': 'garantia',
          'condicoes': 'condicoes'
        };

        if (fieldMap[field]) {
          document.getElementById(fieldMap[field]).value = value;
          persist();
        }
      }
    }

    formatPlaca(placa) {
      if (placa.length > 3) {
        return placa.replace(/^(.{3})(.{1})(.{3})$/, '$1-$2$3');
      }
      return placa;
    }

    skipStep() {
      this.currentStep++;
      return this.getCurrentQuestion();
    }

    previousStep() {
      if (this.currentStep > 0) {
        this.currentStep--;
      }
      return this.getCurrentQuestion();
    }

    reset() {
      this.currentStep = 0;
      this.conversationHistory = [];
      this.userData = {};
      this.currentItem = null;
    }

    addBotMessage(message) {
      const chatMessages = document.getElementById('chat-messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message bot';
      messageDiv.innerHTML = this.formatMessage(message);
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    addUserMessage(message) {
      const chatMessages = document.getElementById('chat-messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message user';
      messageDiv.textContent = message;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    formatMessage(text) {
      return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                 .replace(/\n/g, '<br>');
    }

    showActions() {
      const currentStep = this.getCurrentQuestion();
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'chat-actions';
      
      if (currentStep.skipText) {
        const skipBtn = document.createElement('button');
        skipBtn.className = 'chat-btn';
        skipBtn.textContent = currentStep.skipText;
        skipBtn.onclick = () => this.skipStepAndContinue();
        actionsDiv.appendChild(skipBtn);
      }

      if (this.currentStep > 0) {
        const backBtn = document.createElement('button');
        backBtn.className = 'chat-btn';
        backBtn.textContent = '‚¨ÖÔ∏è Voltar';
        backBtn.onclick = () => this.goBack();
        actionsDiv.appendChild(backBtn);
      }

      if (currentStep.voiceHint && this.recognition) {
        const voiceHelpBtn = document.createElement('button');
        voiceHelpBtn.className = 'chat-btn primary';
        voiceHelpBtn.textContent = 'üé§ Dica de Voz';
        voiceHelpBtn.onclick = () => {
          this.addBotMessage(`üí° **Dica de voz:** ${currentStep.voiceHint}`);
        };
        actionsDiv.appendChild(voiceHelpBtn);
      }

      const chatMessages = document.getElementById('chat-messages');
      chatMessages.appendChild(actionsDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    showFinalActions() {
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'chat-actions';
      
      const actions = [
        { text: 'üìÑ Gerar PDF', class: 'success', action: () => this.gerarPDFDiretamente() },
        { text: 'üí¨ WhatsApp', class: 'primary', action: () => setTimeout(() => btnWhatsapp.click(), 500) },
        { text: 'üìã Copiar Texto', class: 'primary', action: () => setTimeout(() => btnCopyAll.click(), 500) },
        { text: 'üõ†Ô∏è Adicionar Item', class: 'primary', action: () => { this.currentStep = 6; this.askCurrentQuestion(); } },
        { text: 'üñäÔ∏è Assinar', class: 'primary', action: () => {
          const signatureSection = document.querySelector('.signature-section');
          if (signatureSection) signatureSection.scrollIntoView({ behavior: 'smooth' });
        }},
        { text: '‚úèÔ∏è Editar', class: '', action: () => { this.currentStep = 0; this.askCurrentQuestion(); } }
      ];

      actions.forEach(action => {
        const btn = document.createElement('button');
        btn.className = `chat-btn ${action.class}`;
        btn.textContent = action.text;
        btn.onclick = action.action;
        actionsDiv.appendChild(btn);
      });

      const chatMessages = document.getElementById('chat-messages');
      chatMessages.appendChild(actionsDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    skipStepAndContinue() {
      this.addUserMessage(this.getCurrentQuestion().skipText);
      const nextStep = this.skipStep();
      this.askCurrentQuestion();
    }

    goBack() {
      this.addUserMessage('Voltar');
      const prevStep = this.previousStep();
      this.askCurrentQuestion();
    }

    askCurrentQuestion() {
      const question = this.getCurrentQuestion();
      
      if (question.field === 'finalizacao') {
        this.addBotMessage("‚úÖ **Or√ßamento completo!** O que deseja fazer agora?");
        this.showFinalActions();
      } else {
        this.addBotMessage(question.question);
        this.showActions();
      }
    }

    start() {
      this.reset();
      this.askCurrentQuestion();
    }
  }

  // =============================================
  // INICIALIZA√á√ÉO DO CHATBOT
  // =============================================

  const chatbot = new OrcamentoChatbot();

  // Elementos do Chat
  const openChatBtn = document.getElementById('open-chat');
  const closeChatBtn = document.getElementById('close-chat');
  const closeChatMobileBtn = document.getElementById('close-chat-mobile');
  const chatContainer = document.getElementById('chat-container');
  const chatInput = document.getElementById('chat-input');
  const sendChatBtn = document.getElementById('send-chat');
  const chatVoiceBtn = document.getElementById('chat-voice');

  // Event Listeners do Chat - CORRIGIDOS
  openChatBtn.addEventListener('click', () => {
    chatContainer.classList.add('active');
    chatInput.focus();
    if (chatbot.currentStep === 0) {
      setTimeout(() => chatbot.start(), 500);
    }
  });

  // Fun√ß√£o para fechar o chat
  function closeChat() {
    chatContainer.classList.remove('active');
    chatbot.stopListening();
  }

  // M√∫ltiplas formas de fechar o chat
  closeChatBtn.addEventListener('click', closeChat);
  closeChatMobileBtn.addEventListener('click', closeChat);

  // Fechar ao clicar fora do conte√∫do do chat (no overlay)
  chatContainer.addEventListener('click', (e) => {
    if (e.target === chatContainer) {
      closeChat();
    }
  });

  // Fechar com a tecla ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && chatContainer.classList.contains('active')) {
      closeChat();
    }
  });

  sendChatBtn.addEventListener('click', sendMessage);
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  chatVoiceBtn.addEventListener('click', () => {
    if (chatbot.isListening) {
      chatbot.stopListening();
    } else {
      chatbot.startListening();
    }
  });

  function sendMessage() {
    const message = chatInput.value.trim();
    if (message) {
      chatbot.addUserMessage(message);
      chatInput.value = '';

      const currentStep = chatbot.getCurrentQuestion();
      
      if (currentStep.type === 'itens' && chatbot.currentItem) {
        if (!chatbot.currentItem.valor) {
          chatbot.processItemValor(message);
        } else if (!chatbot.currentItem.quantidade) {
          chatbot.processItemQuantidade(message);
        }
      } else if (message.toLowerCase() === 'pr√≥ximo' || message.toLowerCase() === 'proximo') {
        chatbot.skipStepAndContinue();
      } else {
        const nextStep = chatbot.processAnswer(message);
        if (nextStep) {
          if (nextStep.field === 'finalizacao') {
            chatbot.addBotMessage("‚úÖ **Or√ßamento completo!** O que deseja fazer agora?");
            chatbot.showFinalActions();
          } else {
            chatbot.addBotMessage(nextStep.question);
            chatbot.showActions();
          }
        }
      }
    }
  }

  // =============================================
  // C√ìDIGO ORIGINAL DA APLICA√á√ÉO COM CORRE√á√ïES
  // =============================================

  const fmt = new Intl.NumberFormat('pt-BR',{ style:'currency', currency:'BRL' });

  // Elementos
  const titleEl = document.querySelector('title');
  const originalTitle = titleEl.textContent;
  const brandContainerEl = document.getElementById('brand-container');
  const logoImgEl = document.getElementById('logo-img');
  const logoUploadInput = document.getElementById('logo-upload');
  const btnConfigOficina = document.getElementById('btn-config-oficina');
  const oficinaNomeDisplay = document.getElementById('oficina-nome-display');
  const oficinaInfoEl = document.getElementById('oficina-info');
  const dataEmissaoEl = document.getElementById('data-emissao');
  const orcNumEl = document.getElementById('orc-num');
  const validadeInput = document.getElementById('validade');
  const validadeBadge = document.getElementById('validade-badge');

  const clienteNome = document.getElementById('cliente-nome');
  const clienteDoc = document.getElementById('cliente-doc');
  const clienteTel = document.getElementById('cliente-tel');
  const veicPlaca = document.getElementById('veic-placa');
  const veicMarca = document.getElementById('veic-marca');
  const veicModelo = document.getElementById('veic-modelo');
  const veicAnoFabricacao = document.getElementById('veic-ano-fabricacao');
  const veicAnoModelo = document.getElementById('veic-ano-modelo');
  const veicCor = document.getElementById('veic-cor');
  const veicKm = document.getElementById('veic-km');
  const diagnostico = document.getElementById('diagnostico');
  const prazo = document.getElementById('prazo');
  const garantia = document.getElementById('garantia');
  const condicoes = document.getElementById('condicoes');
  const aprovador = document.getElementById('aprovador');
  const dataAprov = document.getElementById('data-aprov');
  const assinatura = document.getElementById('assinatura');
  const obsInterna = document.getElementById('obs-interna');
  
  const mecanicoResp = document.getElementById('mecanico-resp');
  const consultorResp = document.getElementById('consultor-resp');

  const itensBody = document.getElementById('itens-body');
  const totalPecasEl = document.getElementById('total-pecas');
  const totalMdoEl = document.getElementById('total-mdo');
  const totalGeralEl = document.getElementById('total-geral');

  const btnAddItem = document.getElementById('btn-add-item');
  const btnImprimir = document.getElementById('btn-imprimir');
  const btnLimpar = document.getElementById('btn-limpar');
  const btnExportJson = document.getElementById('btn-export-json');
  const btnResetOs = document.getElementById('btn-reset-os');
  const btnConsultarPlaca = document.getElementById('btn-consultar-placa');
  const btnWhatsapp = document.getElementById('btn-whatsapp');
  const btnCopyAll = document.getElementById('btn-copy-all');

  const itemModal = document.getElementById('item-modal');
  const modalTitle = document.getElementById('modal-title');
  const btnCloseModalItem = document.getElementById('btn-close-modal-item');
  const btnCancelModalItem = document.getElementById('btn-cancel-modal-item');
  const btnSaveItem = document.getElementById('btn-save-item');
  const itemDescricaoInput = document.getElementById('item-descricao');
  const itemTipoSelect = document.getElementById('item-tipo');
  const itemQtdInput = document.getElementById('item-qtd');
  const itemValorInput = document.getElementById('item-valor');
  const itemObsTextarea = document.getElementById('item-obs');

  const configModal = document.getElementById('config-modal');
  const btnCloseModalConfig = document.getElementById('btn-close-modal-config');
  const btnCancelModalConfig = document.getElementById('btn-cancel-modal-config');
  const btnSaveConfig = document.getElementById('btn-save-config');
  const configNomeInput = document.getElementById('config-nome');
  const configTelefoneInput = document.getElementById('config-telefone');
  const configEnderecoTextarea = document.getElementById('config-endereco');
  
  const copyModal = document.getElementById('copy-modal');
  const suggestedTitleEl = document.getElementById('suggested-title');
  const btnCloseCopyModal = document.getElementById('btn-close-copy-modal');
  const btnCancelPdf = document.getElementById('btn-cancel-pdf');
  const copyBtn = document.getElementById('copy-btn');
  const generatePdfBtn = document.getElementById('generate-pdf-btn');

  const signatureClient = document.getElementById('signature-client');
  const signatureMechanic = document.getElementById('signature-mechanic');
  const btnClearClient = document.getElementById('btn-clear-client');
  const btnSaveClient = document.getElementById('btn-save-client');
  const btnClearMechanic = document.getElementById('btn-clear-mechanic');
  const btnSaveMechanic = document.getElementById('btn-save-mechanic');

  const vehicleInfoContainer = document.getElementById('vehicle-info-container');
  const vehicleInfoContent = document.getElementById('vehicle-info-content');
  const vehicleInfoPagePrint = document.getElementById('vehicle-info-page-print');
  const vehicleInfoPdfContainer = document.getElementById('vehicle-info-pdf-container');

  let editingItemIndex = -1;
  let isDrawing = false;
  let lastX = 0;
  let lastY = 0;
  let currentCanvas = null;

  // Dados
  let orcamento = {
    numero: 1,
    dataEmissao: new Date().toISOString().slice(0,10),
    validadeDias: 7,
    oficina: { nome:'Auto Box Mec√¢nica', telefone:'(99) 9 9999-9999', endereco:'Rua Exemplo, 123', logoUrl: '' },
    cliente: {},
    veiculo: {},
    responsaveis: { mecanico: '', consultor: '' },
    diagnostico: '',
    itens: [],
    prazo: '',
    garantia: '',
    condicoes: '',
    aprovacao: {},
    obsInterna: '',
    assinaturas: {
      cliente: '',
      mecanico: ''
    },
    veiculoCompleto: {
      informacoesBasicas: {},
      informacoesExtra: {},
      informacoesFipe: {},
      situacao: {}
    }
  };
  
  // --- FUN√á√ïES DE M√ÅSCARA ---
  const cleanNumber = (value) => value ? value.toString().replace(/\D/g, '') : '';
  const cleanAlphaNumeric = (value) => value ? value.toString().replace(/[^a-zA-Z0-9]/g, '') : '';

  function maskCpfCnpj(value) {
      const v = cleanNumber(value);
      if (v.length <= 11) {
          return v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4').slice(0, 14);
      } else {
          return v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5').slice(0, 18);
      }
  }

  function maskPhone(value) {
      const v = cleanNumber(value).slice(0, 11);
      if (v.length <= 10) {
          return v.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
      } else {
          return v.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
      }
  }
  
  function maskPlaca(value) {
      const v = cleanAlphaNumeric(value).toUpperCase().slice(0, 7);
      if (v.length > 3) {
          return v.replace(/^(.{3})(.{1})(.{3})$/, '$1-$2$3');
      }
      return v;
  }
  
  function formatKmForDisplay(value) {
      const v = cleanNumber(value).slice(0, 6);
      if (v) return `${v.replace(/\B(?=(\d{3})+(?!\d))/g, '.')} km`;
      return '';
  }

  function maskMoney(value) {
      let v = cleanNumber(value);
      if (!v) return '';

      const decimalPart = v.slice(-2).padStart(2, '0');
      let integerPart = v.slice(0, -2);
      
      if (integerPart.length > 1 && integerPart[0] === '0') {
          integerPart = integerPart.replace(/^0+/, '');
          if (integerPart === '') integerPart = '0';
      } else if (integerPart === '') {
          integerPart = '0';
      }

      let masked = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      
      masked = `R$ ${masked},${decimalPart}`;
      return masked;
  }

  function unmaskMoney(value) {
    if (!value) return 0;
    const clean = value.toString().replace(/[^0-9,]/g, '').replace(',', '.');
    return parseFloat(clean) || 0;
  }

  function formatDateBr(iso){
    if(!iso) return '';
    const d = new Date(iso + 'T00:00:00');
    if(isNaN(d)) return iso;
    const day = String(d.getDate()).padStart(2,'0');
    const month = String(d.getMonth()+1).padStart(2,'0');
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
  }

  // --- L√ìGICA DE NEG√ìCIO ---
  function calcularTotais() {
    let totalPecas = 0;
    let totalMDO = 0;

    orcamento.itens.forEach(item => {
      const subtotal = item.qtd * item.valor;
      if (item.tipo === 'PECA') {
        totalPecas += subtotal;
      } else if (item.tipo === 'MDO') {
        totalMDO += subtotal;
      }
    });

    const totalGeral = totalPecas + totalMDO;

    totalPecasEl.textContent = fmt.format(totalPecas);
    totalMdoEl.textContent = fmt.format(totalMDO);
    totalGeralEl.textContent = fmt.format(totalGeral);
  }

  function renderItens(){
    itensBody.innerHTML = '';
    orcamento.itens.forEach((item, index) => {
      const subtotal = item.qtd * item.valor;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${index + 1}</td>
        <td>
            ${item.descricao} 
            ${item.obs ? `<div class="muted small">${item.obs}</div>` : ''}
            <div class="muted small">(${item.tipo === 'PECA' ? 'Pe√ßa' : 'M√£o de Obra'})</div>
        </td>
        <td class="text-right">${item.qtd}</td>
        <td class="text-right valor-destaque">${fmt.format(item.valor)}</td>
        <td class="text-right valor-destaque">${fmt.format(subtotal)}</td>
        <td class="no-print actions">
            <button class="btn-ghost small" data-action="edit" data-index="${index}">‚úèÔ∏è</button>
            <button class="btn-danger small" data-action="delete" data-index="${index}">üóëÔ∏è</button>
        </td>
      `;
      itensBody.appendChild(row);
    });
    calcularTotais();
  }

  function openItemModal(index = -1) {
    editingItemIndex = index;
    
    if (index > -1) {
      modalTitle.textContent = 'Editar Item';
      const item = orcamento.itens[index];
      itemDescricaoInput.value = item.descricao;
      itemTipoSelect.value = item.tipo;
      itemQtdInput.value = item.qtd;
      itemValorInput.value = maskMoney(item.valor.toFixed(2));
      itemObsTextarea.value = item.obs;
    } else {
      modalTitle.textContent = 'Adicionar Novo Item';
      itemDescricaoInput.value = '';
      itemTipoSelect.value = 'PECA';
      itemQtdInput.value = '1';
      itemValorInput.value = '';
      itemObsTextarea.value = '';
    }

    itemModal.style.display = 'flex';
  }

  function closeItemModal() {
    itemModal.style.display = 'none';
    editingItemIndex = -1;
  }
  
  function openConfigModal() {
      configModal.style.display = 'flex';
      configNomeInput.value = orcamento.oficina.nome || '';
      configTelefoneInput.value = orcamento.oficina.telefone || '';
      configEnderecoTextarea.value = orcamento.oficina.endereco || '';
  }

  function closeConfigModal() {
      configModal.style.display = 'none';
      renderAll();
  }

  btnSaveItem.addEventListener('click', () => {
    const descricao = itemDescricaoInput.value.trim();
    const tipo = itemTipoSelect.value;
    const qtd = parseFloat(itemQtdInput.value.replace(',', '.')) || 0;
    const valor = unmaskMoney(itemValorInput.value);
    const obs = itemObsTextarea.value.trim();

    if (!descricao || qtd <= 0 || valor < 0) {
      alert('Preencha a descri√ß√£o, quantidade e valor unit√°rio corretamente.');
      return;
    }
    
    const newItem = {
      descricao,
      tipo,
      qtd,
      valor,
      obs
    };

    if (editingItemIndex > -1) {
      orcamento.itens[editingItemIndex] = newItem;
    } else {
      orcamento.itens.push(newItem);
    }

    closeItemModal();
    persist();
    renderAll();
  });

  btnSaveConfig.addEventListener('click', () => {
    orcamento.oficina.nome = configNomeInput.value.trim();
    orcamento.oficina.telefone = configTelefoneInput.value.trim();
    orcamento.oficina.endereco = configEnderecoTextarea.value.trim();

    persist();
    closeConfigModal();
  });

  // --- FUN√á√ïES DE CONSULTA DE PLACA ---
  const TOKEN = "41345b4cfc0993884e04cbcd0de66fa1";
  const API_BASE_URL = "https://wdapi2.com.br/consulta/";

  async function consultarPlaca() {
    const placa = cleanAlphaNumeric(veicPlaca.value).toUpperCase();
    
    if (!placa) {
      alert("Por favor, digite a placa do ve√≠culo.");
      return;
    }

    btnConsultarPlaca.textContent = "‚è≥ Buscando...";
    btnConsultarPlaca.disabled = true;

    const url = `${API_BASE_URL}${placa}/${TOKEN}`;

    try {
      const response = await fetch(url);
      const data = await response.json();
      
      if (response.ok) {
        processarDadosAPI(data);
        alert('Dados do ve√≠culo preenchidos automaticamente!');
        persist();
      } else if (data.message) {
        alert(`Erro na consulta: ${data.message}`);
      } else {
        alert('Erro desconhecido na consulta da placa.');
      }

    } catch (error) {
      console.error('Erro na requisi√ß√£o:', error);
      alert("N√£o foi poss√≠vel conectar √† API. Verifique sua conex√£o.");
    } finally {
      btnConsultarPlaca.textContent = "üîç Buscar Placa";
      btnConsultarPlaca.disabled = false;
    }
  }

  function processarDadosAPI(data) {
    orcamento.veiculoCompleto = {
      informacoesBasicas: {},
      informacoesExtra: {},
      informacoesFipe: {},
      situacao: {}
    };

    // Informa√ß√µes b√°sicas
    if (data.marca) {
      veicMarca.value = data.marca;
      orcamento.veiculoCompleto.informacoesBasicas.marca = data.marca;
    }
    if (data.modelo) {
      veicModelo.value = data.modelo;
      orcamento.veiculoCompleto.informacoesBasicas.modelo = data.modelo;
    }
    if (data.submodelo) {
      orcamento.veiculoCompleto.informacoesBasicas.submodelo = data.submodelo;
    }
    if (data.versao) {
      orcamento.veiculoCompleto.informacoesBasicas.versao = data.versao;
    }
    if (data.ano) {
      veicAnoFabricacao.value = data.ano;
      orcamento.veiculoCompleto.informacoesBasicas.anoFabricacao = data.ano;
    }
    if (data.anoModelo) {
      veicAnoModelo.value = data.anoModelo;
      orcamento.veiculoCompleto.informacoesBasicas.anoModelo = data.anoModelo;
    }
    if (data.cor) {
      veicCor.value = data.cor;
      orcamento.veiculoCompleto.informacoesBasicas.cor = data.cor;
    }
    if (data.extra && data.extra.chassi) {
      orcamento.veiculoCompleto.informacoesBasicas.chassi = data.extra.chassi;
    } else if (data.chassi) {
      orcamento.veiculoCompleto.informacoesBasicas.chassi = data.chassi;
    }
    if (data.placa) {
      orcamento.veiculoCompleto.informacoesBasicas.placa = data.placa;
    }
    if (data.placa_alternativa) {
      orcamento.veiculoCompleto.informacoesBasicas.placaAlternativa = data.placa_alternativa;
    }
    if (data.marcaModelo) {
      orcamento.veiculoCompleto.informacoesBasicas.marcaModelo = data.marcaModelo;
    }
    if (data.origem) {
      orcamento.veiculoCompleto.informacoesBasicas.origem = data.origem;
    }
    if (data.municipio) {
      orcamento.veiculoCompleto.informacoesBasicas.municipio = data.municipio;
    }
    if (data.uf) {
      orcamento.veiculoCompleto.informacoesBasicas.uf = data.uf;
    }
    if (data.logo) {
      orcamento.veiculoCompleto.informacoesBasicas.logo = data.logo;
    }

    // Informa√ß√µes extra
    if (data.extra) {
      orcamento.veiculoCompleto.informacoesExtra = { ...data.extra };
    }

    // Informa√ß√µes FIPE
    if (data.fipe && data.fipe.dados && data.fipe.dados.length > 0) {
      const melhorFipe = data.fipe.dados.reduce((prev, current) => 
        (prev.score > current.score) ? prev : current
      );
      orcamento.veiculoCompleto.informacoesFipe = { ...melhorFipe };
    }

    // Situa√ß√£o do ve√≠culo
    if (data.situacao) {
      orcamento.veiculoCompleto.situacao.situacao = data.situacao;
    }
    if (data.codigoSituacao) {
      orcamento.veiculoCompleto.situacao.codigoSituacao = data.codigoSituacao;
    }
    if (data.data) {
      orcamento.veiculoCompleto.situacao.dataConsulta = data.data;
    }

    renderAll();
    renderVehicleInfo();
  }

  // --- FUN√á√ïES DE ASSINATURA DIGITAL ---
  function initSignatureCanvas() {
  const canvases = [signatureClient, signatureMechanic];
  
  canvases.forEach(canvas => {
    canvas.width = 400;
    canvas.height = 150;
    
    const ctx = canvas.getContext('2d');
    // MUDAN√áA: Usar cor hexadecimal azul
    ctx.strokeStyle = '#0f62fe'; // Ou qualquer cor hexadecimal que voc√™ quiser
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    canvas.addEventListener('touchstart', startDrawingTouch);
    canvas.addEventListener('touchmove', drawTouch);
    canvas.addEventListener('touchend', stopDrawing);
  });
}
  
  function drawSignatureImage(canvas, dataURL) {
      const ctx = canvas.getContext('2d');
      const img = new Image();
      img.onload = function() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      };
      img.src = dataURL;
  }
  
  function startDrawing(e) {
    isDrawing = true;
    currentCanvas = e.target;
    const rect = currentCanvas.getBoundingClientRect();
    lastX = e.clientX - rect.left;
    lastY = e.clientY - rect.top;
  }
  
  function startDrawingTouch(e) {
    e.preventDefault();
    isDrawing = true;
    currentCanvas = e.target;
    const rect = currentCanvas.getBoundingClientRect();
    const touch = e.touches[0];
    lastX = touch.clientX - rect.left;
    lastY = touch.clientY - rect.top;
  }
  
  function draw(e) {
    if (!isDrawing || currentCanvas !== e.target) return;
    
    const rect = currentCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    const ctx = currentCanvas.getContext('2d');
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
    
    lastX = x;
    lastY = y;
  }
  
  function drawTouch(e) {
    e.preventDefault();
    if (!isDrawing || currentCanvas !== e.target) return;
    
    const rect = currentCanvas.getBoundingClientRect();
    const touch = e.touches[0];
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    
    const ctx = currentCanvas.getContext('2d');
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
    
    lastX = x;
    lastY = y;
  }
  
  function stopDrawing() {
    isDrawing = false;
  }
  
  function clearSignature(canvasId) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    canvas.removeAttribute('data-has-signature');
    
    if (canvasId === 'signature-client') {
      orcamento.assinaturas.cliente = '';
    } else if (canvasId === 'signature-mechanic') {
      orcamento.assinaturas.mecanico = '';
    }
    
    persist();
  }
  
  function saveSignature(canvasId) {
    const canvas = document.getElementById(canvasId);
    const dataURL = canvas.toDataURL('image/png');
    
    canvas.setAttribute('data-has-signature', 'true');
    
    if (canvasId === 'signature-client') {
      orcamento.assinaturas.cliente = dataURL;
    } else if (canvasId === 'signature-mechanic') {
      orcamento.assinaturas.mecanico = dataURL;
    }
    
    persist();
    alert('Assinatura salva com sucesso!');
  }
  
  function loadSignatures() {
    if (orcamento.assinaturas.cliente) {
      drawSignatureImage(signatureClient, orcamento.assinaturas.cliente);
      signatureClient.setAttribute('data-has-signature', 'true');
    }
    
    if (orcamento.assinaturas.mecanico) {
      drawSignatureImage(signatureMechanic, orcamento.assinaturas.mecanico);
      signatureMechanic.setAttribute('data-has-signature', 'true');
    }
  }

  // --- FUN√á√ÉO PARA RENDERIZAR INFORMA√á√ïES DO VE√çCULO ---
  function renderVehicleInfo() {
    let htmlContent = '';
    
    if (Object.keys(orcamento.veiculoCompleto.informacoesBasicas).length === 0) {
      htmlContent = '<p class="muted" style="padding: 16px;">As informa√ß√µes completas do ve√≠culo aparecer√£o aqui ap√≥s a consulta da placa.</p>';
    } else {
      const basic = orcamento.veiculoCompleto.informacoesBasicas;
      const extra = orcamento.veiculoCompleto.informacoesExtra;
      const fipe = orcamento.veiculoCompleto.informacoesFipe;
      const situacao = orcamento.veiculoCompleto.situacao;
      
      if (basic.logo) {
          htmlContent += `
              <div id="vehicle-logo-display">
                  <img src="${basic.logo}" alt="Logo ${basic.marca}" onerror="this.style.display='none'">
              </div>
          `;
      }
      
      htmlContent += `<div class="vehicle-detail-grid-display">`;
      
      const addItem = (label, value) => {
        if (value) {
            htmlContent += `
                <div class="vehicle-detail-item-display">
                    <div class="vehicle-detail-label-display">${label}</div>
                    <div class="vehicle-detail-value-display">${value}</div>
                </div>
            `;
        }
      };
      
      addItem('Marca', basic.marca);
      addItem('Modelo', basic.modelo);
      addItem('Ano Fab.', basic.anoFabricacao);
      addItem('Ano Mod.', basic.anoModelo);
      addItem('Cor', basic.cor);
      addItem('Placa Completa', basic.placa);
      addItem('Chassi', basic.chassi || 'N√£o Informado');
      addItem('Origem', basic.origem);
      addItem('Munic√≠pio/UF', `${basic.municipio || 'N/I'} - ${basic.uf || 'N/I'}`);
      
      addItem('Combust√≠vel', extra.combustivel);
      addItem('Cilindradas', extra.cilindradas);
      addItem('Tipo Ve√≠culo', extra.tipo_veiculo || extra.especie);
      addItem('Carroceria', extra.carroceria);
      addItem('Passageiros', extra.quantidade_passageiro);
      
      addItem('Situa√ß√£o', situacao.situacao);
      
      addItem('Valor FIPE', fipe.texto_valor);
      addItem('Ano Modelo FIPE', fipe.ano_modelo);
      addItem('M√™s Ref. FIPE', fipe.mes_referencia);

      htmlContent += `</div>`;
    }
    
    vehicleInfoContent.innerHTML = htmlContent;
    
    criarInformacoesVeiculoPDF();
  }

  function criarInformacoesVeiculoPDF() {
    if (Object.keys(orcamento.veiculoCompleto.informacoesBasicas).length === 0) {
      vehicleInfoPdfContainer.innerHTML = '';
      return;
    }
    
    const basic = orcamento.veiculoCompleto.informacoesBasicas;
    const extra = orcamento.veiculoCompleto.informacoesExtra;
    const fipe = orcamento.veiculoCompleto.informacoesFipe;
    const situacao = orcamento.veiculoCompleto.situacao;
    
    let html = `
      <div class="vehicle-info-pdf">
        <h3>INFORMA√á√ïES COMPLETAS DO VE√çCULO</h3>
        <div class="vehicle-detail-grid-pdf">
    `;
    
    const addItemPDF = (label, value) => {
      if (value) {
        html += `
          <div class="vehicle-detail-item-pdf">
            <div class="vehicle-detail-label-pdf">${label}</div>
            <div class="vehicle-detail-value-pdf">${value}</div>
          </div>
        `;
      }
    };
    
    addItemPDF('Marca', basic.marca);
    addItemPDF('Modelo', basic.modelo);
    addItemPDF('Ano Fab.', basic.anoFabricacao);
    addItemPDF('Ano Mod.', basic.anoModelo);
    addItemPDF('Cor', basic.cor);
    addItemPDF('Placa Completa', basic.placa);
    addItemPDF('Chassi', basic.chassi);
    addItemPDF('Origem', basic.origem);
    addItemPDF('Munic√≠pio/UF', `${basic.municipio || ''} - ${basic.uf || ''}`);
    
    addItemPDF('Combust√≠vel', extra.combustivel);
    addItemPDF('Cilindradas', extra.cilindradas);
    addItemPDF('Tipo Ve√≠culo', extra.tipo_veiculo || extra.especie);
    addItemPDF('Carroceria', extra.carroceria);
    addItemPDF('Passageiros', extra.quantidade_passageiro);
    
    addItemPDF('Situa√ß√£o', situacao.situacao);
    
    addItemPDF('Valor FIPE', fipe.texto_valor);
    addItemPDF('Ano Modelo FIPE', fipe.ano_modelo);
    addItemPDF('M√™s Ref. FIPE', fipe.mes_referencia);
    
    html += `
        </div>
      </div>
    `;
    
    vehicleInfoPdfContainer.innerHTML = html;
  }

  // --- FUN√á√ïES DE IMPRESS√ÉO/PDF ---
  function prepareForPrint() {
    // CORRE√á√ÉO: Marcar campos vazios
    const inputs = document.querySelectorAll('input, textarea');
    inputs.forEach(input => {
      if (!input.value.trim() && input.value.trim() !== '0') {
        input.classList.add('empty-field');
      } else {
        input.classList.remove('empty-field');
      }
    });
    
    // CORRE√á√ÉO: Marcar cards vazios
    const cards = document.querySelectorAll('.card');
    cards.forEach(card => {
      const hasContent = Array.from(card.querySelectorAll('input, textarea, table tbody tr'))
        .some(el => {
          if (el.tagName === 'TR') {
            return true;
          }
          return el.value && el.value.trim() && !el.classList.contains('empty-field');
        });
      
      if (!hasContent) {
        card.classList.add('empty-card');
      } else {
        card.classList.remove('empty-card');
      }
    });
    
    // CORRE√á√ÉO: Marcar se√ß√µes vazias
    const sections = document.querySelectorAll('.row, .signature-section, .signature-box');
    sections.forEach(section => {
      const hasContent = Array.from(section.querySelectorAll('input, textarea, canvas'))
        .some(el => {
          if (el.tagName === 'CANVAS') {
            return el.hasAttribute('data-has-signature');
          }
          return el.value && el.value.trim() && !el.classList.contains('empty-field');
        });
      
      if (!hasContent) {
        section.classList.add('empty-section');
      } else {
        section.classList.remove('empty-section');
      }
    });
    
    if (veicKm.value.trim()) {
      veicKm.value = formatKmForDisplay(veicKm.value);
    }
    
    veicPlaca.classList.add('placa-destaque-print');
    
    vehicleInfoContainer.style.display = 'none';
    vehicleInfoPdfContainer.style.display = 'block';
    
    const orcNumFmt = String(orcamento.numero).padStart(4,'0');
    const fileNameSuffix = getFileNameSuffix();
    titleEl.textContent = `Or√ßamento_${orcNumFmt}${fileNameSuffix}`;
  }
  
  function restoreAfterPrint() {
    const elements = document.querySelectorAll('.empty-field, .empty-section, .empty-card');
    elements.forEach(el => {
      el.classList.remove('empty-field', 'empty-section', 'empty-card');
    });
    
    veicPlaca.classList.remove('placa-destaque-print');
    
    vehicleInfoContainer.style.display = 'block';
    vehicleInfoPdfContainer.style.display = 'none';
    
    titleEl.textContent = originalTitle;
    
    const originalKm = orcamento.veiculo.km || '';
    veicKm.value = originalKm;
  }

  // --- FUN√á√ÉO PARA COPIAR TODAS AS INFORMA√á√ïES ---
  function getFullMessageText(isWhatsapp = false) {
      persist();
      
      let texto = `*OR√áAMENTO N¬∫ ${String(orcamento.numero).padStart(4, '0')} - ${orcamento.oficina.nome}*\n\n`;
      
      texto += `*DADOS DO CLIENTE:*\n`;
      if (clienteNome.value.trim()) texto += `Nome: ${clienteNome.value}\n`;
      if (clienteDoc.value.trim()) texto += `CPF/CNPJ: ${clienteDoc.value}\n`;
      if (clienteTel.value.trim()) texto += `Telefone: ${clienteTel.value}\n`;
      
      texto += `\n*DADOS DO VE√çCULO:*\n`;
      if (veicPlaca.value.trim()) texto += `Placa: ${veicPlaca.value}\n`;
      if (veicMarca.value.trim()) texto += `Marca: ${veicMarca.value}\n`;
      if (veicModelo.value.trim()) texto += `Modelo: ${veicModelo.value}\n`;
      if (veicAnoFabricacao.value.trim() || veicAnoModelo.value.trim()) texto += `Ano Fab/Mod: ${veicAnoFabricacao.value || 'N/I'}/${veicAnoModelo.value || 'N/I'}\n`;
      if (veicCor.value.trim()) texto += `Cor: ${veicCor.value}\n`;
      
      const kmValue = orcamento.veiculo.km;
      if (kmValue) {
          texto += `Km: ${kmValue}\n`;
      }
      
      if (Object.keys(orcamento.veiculoCompleto.informacoesBasicas).length > 0) {
        const basic = orcamento.veiculoCompleto.informacoesBasicas;
        const extra = orcamento.veiculoCompleto.informacoesExtra;
        const fipe = orcamento.veiculoCompleto.informacoesFipe;
        const situacao = orcamento.veiculoCompleto.situacao;

        texto += `\n*DADOS COMPLETOS (API):*\n`;
        if (basic.chassi) texto += `Chassi: ${basic.chassi}\n`;
        if (basic.origem) texto += `Origem: ${basic.origem}\n`;
        if (extra.combustivel) texto += `Combust√≠vel: ${extra.combustivel}\n`;
        if (extra.cilindradas) texto += `Cilindradas: ${extra.cilindradas}\n`;
        const tipoVeiculo = extra.tipo_veiculo || extra.especie;
        if (tipoVeiculo) texto += `Tipo: ${tipoVeiculo}\n`;
        if (situacao.situacao) texto += `Situa√ß√£o: ${situacao.situacao}\n`;
        if (fipe.texto_valor) texto += `Valor FIPE: ${fipe.texto_valor}\n`;

        texto += `---------------------------------\n`;
      }
      
      texto += `\n*DIAGN√ìSTICO:*\n${diagnostico.value || 'N√£o informado'}\n`;
      
      texto += `\n*ITENS DO OR√áAMENTO:*\n`;
      
      let totalPecas = 0;
      let totalMDO = 0;
      
      if (orcamento.itens.length > 0) {
        orcamento.itens.forEach((item, index) => {
          const subtotal = item.qtd * item.valor;
          texto += `${index + 1}. ${item.descricao} (${item.tipo === 'PECA' ? 'Pe√ßa' : 'M.O.'}) - ${item.qtd}x ${fmt.format(item.valor)} = ${fmt.format(subtotal)}\n`;
          
          if (item.tipo === 'PECA') totalPecas += subtotal;
          if (item.tipo === 'MDO') totalMDO += subtotal;
        });
      } else {
        texto += `Nenhum item adicionado\n`;
      }
      
      const totalGeral = totalPecas + totalMDO;
      
      texto += `\n*TOTAIS:*\n`;
      texto += `Pe√ßas: ${fmt.format(totalPecas)}\n`;
      texto += `M√£o de Obra: ${fmt.format(totalMDO)}\n`;
      texto += `*TOTAL GERAL: ${fmt.format(totalGeral)}*\n\n`;
      
      texto += `*CONDI√á√ïES:*\n`;
      if (prazo.value.trim()) texto += `Prazo: ${prazo.value}\n`;
      if (garantia.value.trim()) texto += `Garantia: ${garantia.value}\n`;
      if (condicoes.value.trim()) texto += `Pagamento: ${condicoes.value}\n`;
      
      if (aprovador.value.trim() || dataAprov.value.trim() || assinatura.value.trim()) {
        texto += `\n*APROVA√á√ÉO:*\n`;
        if (aprovador.value.trim()) texto += `Aprovador: ${aprovador.value}\n`;
        if (dataAprov.value.trim()) texto += `Data: ${formatDateBr(dataAprov.value)}\n`;
        if (assinatura.value.trim()) texto += `Assinatura: ${assinatura.value}\n`;
      }
      
      texto += `\n_Or√ßamento v√°lido por ${validadeInput.value} dias_\n`;
      texto += `Emiss√£o: ${dataEmissaoEl.textContent}`;
      
      return texto;
  }

  function copiarTodasInformacoes() {
    const texto = getFullMessageText(false);
    
    navigator.clipboard.writeText(texto).then(() => {
      alert('Todas as informa√ß√µes do or√ßamento foram copiadas para a √°rea de transfer√™ncia!');
    }).catch(err => {
      console.error('Erro ao copiar:', err);
      alert('N√£o foi poss√≠vel copiar automaticamente. Selecione e copie o texto manualmente.');
    });
  }
  
  function enviarWhatsApp() {
    const mensagem = getFullMessageText(true);
    const mensagemCodificada = encodeURIComponent(mensagem);
    
    const urlWhatsApp = `https://wa.me/?text=${mensagemCodificada}`;
    
    window.open(urlWhatsApp, '_blank');
  }

  function limparTudo() {
    if(!confirm('Tem certeza que deseja LIMPAR TODOS os dados do or√ßamento? Todos os campos ser√£o resetados para o estado inicial.')) return;
    
    const allInputs = document.querySelectorAll('input, textarea');
    allInputs.forEach(input => {
      if (input.id !== 'validade') {
        input.value = '';
      }
    });
    
    validadeInput.value = '7';
    
    clearSignature('signature-client');
    clearSignature('signature-mechanic');
    
    orcamento = {
      numero: orcamento.numero,
      dataEmissao: new Date().toISOString().slice(0,10),
      validadeDias: 7,
      oficina: orcamento.oficina,
      responsaveis: { mecanico: '', consultor: '' },
      cliente: {},
      veiculo: {},
      diagnostico: '',
      itens: [],
      prazo: '',
      garantia: '',
      condicoes: '',
      aprovacao: {},
      obsInterna: '',
      assinaturas: {
        cliente: '',
        mecanico: ''
      },
      veiculoCompleto: {
        informacoesBasicas: {},
        informacoesExtra: {},
        informacoesFipe: {},
        situacao: {}
      }
    };
    
    persist();
    renderAll();
    
    alert('Todos os dados foram limpos com sucesso!');
  }

  // Inicializa√ß√£o
  function init(){
    const saved = localStorage.getItem('orcamento_oficina_v1');
    if(saved){
      try{
        const loadedData = JSON.parse(saved);
        orcamento.oficina = {
            nome: loadedData.oficina.nome || 'Auto Box Mec√¢nica',
            telefone: loadedData.oficina.telefone || '(00) 0000-0000',
            endereco: loadedData.oficina.endereco || 'Endere√ßo da oficina',
            logoUrl: loadedData.oficina.logoUrl || ''
        };
        orcamento.responsaveis = loadedData.responsaveis || { mecanico: '', consultor: '' };
        orcamento.assinaturas = loadedData.assinaturas || { cliente: '', mecanico: '' };
        orcamento.veiculoCompleto = loadedData.veiculoCompleto || {
          informacoesBasicas: {},
          informacoesExtra: {},
          informacoesFipe: {},
          situacao: {}
        };

        if(!loadedData.veiculo || typeof loadedData.veiculo.km === 'undefined') {
             loadedData.veiculo = loadedData.veiculo || {};
             loadedData.veiculo.km = '';
        }

        Object.assign(orcamento, loadedData);
        orcamento.numero = Number(loadedData.numero) || 1;

      }catch(e){
        console.warn('Falha ao ler localStorage:', e);
        orcamento.numero = Number(localStorage.getItem('orcamento_numero') || 1);
      }
    } else {
        orcamento.numero = Number(localStorage.getItem('orcamento_numero') || 1);
    }
    
    initSignatureCanvas();
    setTimeout(loadSignatures, 100);
    
    renderAll();
  }
  
  function renderAll(){
    const hasLogo = !!orcamento.oficina.logoUrl;
    brandContainerEl.classList.toggle('has-logo', hasLogo);
    logoImgEl.src = orcamento.oficina.logoUrl || '';
    logoImgEl.style.display = hasLogo ? 'block' : 'none';

    oficinaNomeDisplay.textContent = orcamento.oficina.nome;
    oficinaInfoEl.textContent = `${orcamento.oficina.nome} ‚Ä¢ ${orcamento.oficina.telefone} ‚Ä¢ ${orcamento.oficina.endereco}`;
    orcNumEl.textContent = String(orcamento.numero).padStart(4,'0');
    dataEmissaoEl.textContent = formatDateBr(orcamento.dataEmissao);
    validadeBadge.textContent = `Validade: ${orcamento.validadeDias || 7} dias`;

    clienteNome.value = orcamento.cliente.nome || '';
    clienteDoc.value = orcamento.cliente.doc ? maskCpfCnpj(orcamento.cliente.doc) : '';
    clienteTel.value = orcamento.cliente.tel ? maskPhone(orcamento.cliente.tel) : '';
    veicPlaca.value = orcamento.veiculo.placa ? maskPlaca(orcamento.veiculo.placa) : '';
    
    veicMarca.value = orcamento.veiculoCompleto.informacoesBasicas.marca || orcamento.veiculo.marca || '';
    veicModelo.value = orcamento.veiculoCompleto.informacoesBasicas.modelo || orcamento.veiculo.modelo || '';
    veicAnoFabricacao.value = orcamento.veiculoCompleto.informacoesBasicas.anoFabricacao || orcamento.veiculo.anoFabricacao || '';
    veicAnoModelo.value = orcamento.veiculoCompleto.informacoesBasicas.anoModelo || orcamento.veiculo.anoModelo || '';
    veicCor.value = orcamento.veiculoCompleto.informacoesBasicas.cor || orcamento.veiculo.cor || '';
    veicKm.value = orcamento.veiculo.km || '';
    
    diagnostico.value = orcamento.diagnostico || '';
    prazo.value = orcamento.prazo || '';
    garantia.value = orcamento.garantia || '';
    condicoes.value = orcamento.condicoes || '';
    aprovador.value = orcamento.aprovacao.nome || '';
    dataAprov.value = orcamento.aprovacao.data || '';
    assinatura.value = orcamento.aprovacao.assinatura || '';
    obsInterna.value = orcamento.obsInterna || '';
    validadeInput.value = orcamento.validadeDias || 7;
    
    mecanicoResp.value = orcamento.responsaveis.mecanico || '';
    consultorResp.value = orcamento.responsaveis.consultor || '';

    renderItens();
    calcularTotais();
    renderVehicleInfo();
  }
  
  function persist(){
    orcamento.validadeDias = Number(validadeInput.value) || 7;

    orcamento.cliente = {
      nome: clienteNome.value,
      doc: cleanNumber(clienteDoc.value),
      tel: cleanNumber(clienteTel.value)
    };
    
    orcamento.veiculo = {
      placa: cleanAlphaNumeric(veicPlaca.value).toUpperCase(),
      km: cleanNumber(veicKm.value) || ''
    };
    
    orcamento.veiculo.marca = veicMarca.value;
    orcamento.veiculo.modelo = veicModelo.value;
    orcamento.veiculo.anoFabricacao = veicAnoFabricacao.value;
    orcamento.veiculo.anoModelo = veicAnoModelo.value;
    orcamento.veiculo.cor = veicCor.value;

    orcamento.responsaveis = {
        mecanico: mecanicoResp.value,
        consultor: consultorResp.value
    };

    orcamento.diagnostico = diagnostico.value;
    orcamento.prazo = prazo.value;
    orcamento.garantia = garantia.value;
    orcamento.condicoes = condicoes.value;
    orcamento.aprovacao = {
      nome: aprovador.value,
      data: dataAprov.value,
      assinatura: assinatura.value
    };
    orcamento.obsInterna = obsInterna.value;

    if(!orcamento.dataEmissao) orcamento.dataEmissao = new Date().toISOString().slice(0,10);

    localStorage.setItem('orcamento_oficina_v1', JSON.stringify(orcamento));
    localStorage.setItem('orcamento_numero', String(orcamento.numero));
  }
  
  function getFileNameSuffix() {
    const placa = orcamento.veiculo.placa || 'SemPlaca';
    let marca = orcamento.veiculoCompleto.informacoesBasicas.marca || orcamento.veiculo.marca || 'SemMarca';
    let modelo = orcamento.veiculoCompleto.informacoesBasicas.modelo || orcamento.veiculo.modelo || 'SemModelo';
    
    const cleanName = (name) => name
      .trim()
      .toUpperCase()
      .replace(/[^A-Z0-9]/g, '-')
      .replace(/-{2,}/g, '-')
      .replace(/^-+|-+$/g, '')
      .slice(0, 30);

    marca = cleanName(marca);
    modelo = cleanName(modelo);

    let suffix = `_${placa}`;
    if (marca && marca !== 'SEMMARCA') {
        suffix += `_${marca}`;
    }
    if (modelo && modelo !== 'SEMMODELO') {
        suffix += `_${modelo}`;
    }
    return suffix;
  }

  function executePrint() {
      prepareForPrint();
      
      window.print();
      
      orcamento.numero++;
      localStorage.setItem('orcamento_numero', String(orcamento.numero));
      
      setTimeout(() => {
          restoreAfterPrint();
          renderAll();
      }, 500);
  }

  // --- FLUXO DE IMPRESS√ÉO ---
  btnImprimir.addEventListener('click', () => {
      persist();
      const orcNumFmt = String(orcamento.numero).padStart(4,'0');
      const fileNameSuffix = getFileNameSuffix();
      const suggestedFileName = `Or√ßamento_${orcNumFmt}${fileNameSuffix}`;
      
      suggestedTitleEl.textContent = suggestedFileName;
      copyModal.style.display = 'flex';
      copyBtn.textContent = 'Copiar T√≠tulo';
      copyBtn.classList.remove('copy-success', 'btn-danger');
      copyBtn.classList.add('btn-primary');
  });

  copyBtn.addEventListener('click', () => {
      const titleToCopy = suggestedTitleEl.textContent;
      let success = false;
      
      try {
          const tempInput = document.createElement('textarea');
          tempInput.value = titleToCopy;
          tempInput.style.position = 'absolute';
          tempInput.style.left = '-9999px';
          document.body.appendChild(tempInput);
          
          tempInput.select();
          tempInput.setSelectionRange(0, 99999);
          
          success = document.execCommand('copy');
          
          document.body.removeChild(tempInput);
      } catch (err) {
          console.error('Falha ao usar document.execCommand:', err);
      }

      if (success) {
          copyBtn.textContent = '‚úÖ Copiado!';
          copyBtn.classList.remove('btn-primary');
          copyBtn.classList.add('copy-success');
      } else {
          copyBtn.textContent = '‚ùå Falha - Copie Manualmente';
          copyBtn.classList.remove('btn-primary');
          copyBtn.classList.add('btn-danger');
      }
      
      setTimeout(() => {
          copyBtn.textContent = 'Copiar T√≠tulo';
          copyBtn.classList.add('btn-primary');
          copyBtn.classList.remove('copy-success', 'btn-danger');
      }, 2000);
  });

  generatePdfBtn.addEventListener('click', () => {
      copyModal.style.display = 'none';
      executePrint();
  });

  const closeCopyModal = () => {
      copyModal.style.display = 'none';
  };

  btnCloseCopyModal.addEventListener('click', closeCopyModal);
  btnCancelPdf.addEventListener('click', closeCopyModal);
  copyModal.addEventListener('click', (e) => {
      if (e.target === copyModal) closeCopyModal();
  });
  
  // --- Bot√£o Zerar Contador de OS ---
  btnResetOs.addEventListener('click', () => {
      if(confirm('Tem certeza que deseja ZERAR o contador de Ordem de Servi√ßo (OS)? O pr√≥ximo or√ßamento come√ßar√° em 0001.')) {
          orcamento.numero = 1;
          localStorage.setItem('orcamento_numero', 1);
          renderAll();
          alert('Contador de OS zerado! O pr√≥ximo or√ßamento ser√° o n√∫mero 0001.');
      }
  });

  // --- Bot√£o Copiar Todas as Informa√ß√µes ---
  btnCopyAll.addEventListener('click', copiarTodasInformacoes);

  // CORRE√á√ÉO: Bot√£o Limpar Tudo
  btnLimpar.addEventListener('click', limparTudo);

  // --- OUTROS EVENTOS ---
  itensBody.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const action = btn.getAttribute('data-action');
    const index = parseInt(btn.getAttribute('data-index'));

    if (action === 'edit') {
      openItemModal(index);
    } else if (action === 'delete') {
      if (confirm('Tem certeza que deseja remover este item?')) {
        orcamento.itens.splice(index, 1);
        persist();
        renderAll();
      }
    }
  });

  const allInputs = [
    validadeInput, clienteNome, clienteDoc, clienteTel, veicPlaca, veicMarca, veicModelo, 
    veicAnoFabricacao, veicAnoModelo, veicCor, veicKm, 
    diagnostico, prazo, garantia, condicoes, aprovador, dataAprov, assinatura, obsInterna,
    mecanicoResp, consultorResp 
  ];
  
  allInputs.forEach(el=>{
    if (el) {
      el.addEventListener('change', ()=>{ persist(); renderAll(); });
      el.addEventListener('input', ()=>{ 
          if(el.id === 'cliente-doc') el.value = maskCpfCnpj(el.value);
          if(el.id === 'cliente-tel') el.value = maskPhone(el.value);
          if(el.id === 'veic-placa') el.value = maskPlaca(el.value);
          persist(); 
      });
    }
  });

  logoUploadInput.addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        orcamento.oficina.logoUrl = e.target.result;
        persist();
        renderAll();
      };
      reader.readAsDataURL(file);
    }
  });

  itemValorInput.addEventListener('input', () => {
    itemValorInput.value = maskMoney(itemValorInput.value);
  });

  btnConsultarPlaca.addEventListener('click', consultarPlaca);

  veicPlaca.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      consultarPlaca();
    }
  });

  btnWhatsapp.addEventListener('click', enviarWhatsApp);

  btnClearClient.addEventListener('click', () => clearSignature('signature-client'));
  btnSaveClient.addEventListener('click', () => saveSignature('signature-client'));
  btnClearMechanic.addEventListener('click', () => clearSignature('signature-mechanic'));
  btnSaveMechanic.addEventListener('click', () => saveSignature('signature-mechanic'));

  btnAddItem.addEventListener('click', () => openItemModal(-1));
  btnCloseModalItem.addEventListener('click', closeItemModal);
  btnCancelModalItem.addEventListener('click', closeItemModal);

  btnConfigOficina.addEventListener('click', openConfigModal);
  btnCloseModalConfig.addEventListener('click', closeConfigModal);
  btnCancelModalConfig.addEventListener('click', closeConfigModal);

  btnExportJson.addEventListener('click', ()=>{
    persist();
    
    const orcNumFmt = String(orcamento.numero).padStart(4,'0');
    const fileNameSuffix = getFileNameSuffix();
    const fileName = `Dados_OS_${orcNumFmt}${fileNameSuffix}.json`;

    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(orcamento, null, 2));
    const dl = document.createElement('a');
    dl.setAttribute('href', dataStr);
    dl.setAttribute('download', fileName);
    dl.click();
    
    alert(`Arquivo JSON exportado com sucesso com o nome: "${fileName}".`);
  });
  
  init();
</script>
</body>
</html>
